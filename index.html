<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="South Jerusalem Watch" />
    <meta name="theme-color" content="#0f172a" />

    <!-- iOS PWA -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SJ Watch" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png" />

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" href="/favicon-16x16.png" type="image/png" />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Manifest -->
    <link rel="canonical" href="https://jonahhess.github.io/jwatch/" />
    <link
      rel="manifest"
      href="https://jonahhess.github.io/jwatch/manifest.json"
    />

    <title>South Jerusalem Watch</title>

    <style>
      :root {
        /* Spacing scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 1rem;
        --space-4: 1.5rem;
        --space-5: 2rem;

        --space: 0.75rem;

        /* Typography */
        --font-base:
          system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;

        --text-base: 1rem;
        --text-small: 0.875rem;
        --text-large: 1.25rem;

        --text-bold: 600;

        /* Colors */
        --color-bg: #f7f7f7;
        --color-surface: #ffffff;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-accent: #0a66c2;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        font-family: var(--font-base);
        font-size: clamp(15px, 0.9vw + 0.5rem, 18px);
        line-height: 1.5;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
        max-width: 900px;
        margin: auto;
        height: 100vh;
      }

      #title-meta {
        display: flex;
        align-items: center;
        gap: var(--space);
      }

      #logo-container {
        margin-top: var(--space);
      }

      #logo-container img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        display: block;
      }

      #title {
        margin: 0;
        font-size: var(--text-large);
        line-height: 1.2;
      }

      /* New addition */
      #align-end {
        margin-inline-start: auto;
        gap: var(--space);
        display: flex;
      }

      section {
        margin: var(--space-2);
      }

      main {
        padding-left: var(--space-3);
        padding-right: var(--space-3);
      }

      #offline-banner {
        background-color: #fffbcc;
        color: var(--color-muted);
        padding: var(--space-2) var(--space-3);
        text-align: center;
        font-size: var(--text-small);
        border-bottom: 1px solid #f0e68c;
        position: sticky;
        top: 0;
        z-index: 1001;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        position: relative;
        z-index: 0;
        overflow: visible;
      }

      button {
        font: inherit;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: fit-content;
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      #status {
        min-height: var(--space-4);
        margin-top: var(--space-2);
      }

      .card {
        background: var(--color-surface);
        border-radius: var(--space);
        padding: var(--space-2);
        border: 1px solid var(--color-border);
        margin: 0 auto;
        margin-top: 0 auto;
        min-height: 85vh;
      }

      #hint {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      label {
        font-size: var(--text-small);
      }

      input {
        font: inherit;
        padding: var(--space-2);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
      }

      html[dir="rtl"] {
        direction: rtl;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: var(--space-2);
      }

      .form-row {
        width: 100%;
      }

      label span {
        display: block;
        font-weight: var(--text-bold);
        margin-bottom: var(--space-1);
      }

      input,
      textarea,
      select,
      button {
        width: 100%;
        font-size: var(--text-base);
        min-height: 3rem;
        color: var(--color-text);
      }

      @supports (-webkit-touch-callout: none) {
        *,
        *::before,
        *::after {
          -webkit-tap-highlight-color: transparent;
        }
        body {
          -webkit-text-size-adjust: 100%;
        }
        button {
          -webkit-tap-highlight-color: initial;
        }
        input[type="date"],
        input[type="time"] {
          width: calc(100% - 16px);
        }
      }

      textarea {
        border-color: lightgrey;
        border-radius: var(--space-2);
      }

      .inline-controls {
        display: flex;
        gap: var(--space-2);
      }

      select[multiple] {
        min-height: 8rem;
      }

      .popover-content > * {
        list-style: none;
        margin: var(--space-2);
        padding: var(--space-2);
      }

      .option-list li {
        margin-bottom: var(--space-2);
      }

      .option-list label {
        display: flex;
        align-items: center;
        gap: var(--space);

        padding: var(--space) var(--space-3);
        border-radius: 8px;
        cursor: pointer;

        border: 1px solid #ddd;

        transition:
          background 0.2s,
          border-color 0.2s;
      }

      .option-list input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .option-list label:hover {
        background: #f5f7fa;
      }

      .option-list input:checked + span {
        font-weight: var(--text-bold);
      }

      .option-list input:checked + span::before {
        content: "‚úì";
        display: inline-block;
        margin-inline-end: var(--space-2);
      }

      .option-list input:focus-visible + span {
        outline: 2px so;
      }

      #map,
      #map-2 {
        aspect-ratio: 1 / 1;
        width: 100%;
        min-width: 300px;
        margin-bottom: var(--space);
        border-radius: 6px;
        border: 1px solid #ccc;
        max-height: 70vh;
      }

      #map-2 {
        max-height: 45vh;
        margin-inline-start: -0.75rem;
      }

      .popover {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--space-2);
        padding: calc(var(--space-3) * 1.5);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);

        position: fixed;

        width: 100%;
        max-width: min(28rem, 90vw);
        max-height: 55vh;
        overflow: hidden;
        overscroll-behavior: none;
        z-index: 1;
      }

      .popover-content {
        max-height: 100%;
        min-height: 50vh;
        overflow-y: auto; /* scrolls internally */
        padding-top: 1rem; /* optional, space below close button */
        scrollbar-width: thin;
        overscroll-behavior: none;
      }

      .popover-close {
        position: absolute;
        inset-block-start: 0;
        inset-inline-end: 0;

        width: 0.5rem;
        height: 0.5rem;

        display: flex;
        align-items: center;
        justify-content: center;

        background: #eee;
        color: #555;

        border: none;
        border-radius: 0.375rem;

        font-size: var(--text-large);
        line-height: 1;
        cursor: pointer;
      }

      .popover-close:active {
        background: #ccc;
      }

      /* Wider variant for forms */
      .popover--wide {
        max-width: min(32rem, 95vw);
      }

      /* Optional: animation */
      .popover:popover-open {
        animation: fade-in 120ms ease-out;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 600px) {
        .popover {
          width: 90vw;
          max-width: 90vw;
        }
      }

      @media (hover: hover) {
        button:hover {
          background: #f0f0f0;
        }
        .popover-close:hover {
          background: #ddd;
        }
      }
      ul {
        list-style-type: none;
      }
      #home > ul {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: space-evenly;
        height: 100%;
      }
      ul > li > button {
        display: block;
        background-color: #0a66c2;
        color: white;
        height: 15vh;
        max-width: none;
      }
      ul > li > button:hover {
        background-color: #0d7ceb;
        color: white;
      }
      .back-button {
        margin-bottom: 0.5rem;
      }

      .home-button {
        margin-inline-start: -1.3rem;
        margin-top: 1rem;
      }
    </style>
  </head>

  <body>
    <main>
      <div id="offline-banner" hidden data-i18n="offline"></div>

      <header>
        <div id="title-meta">
          <div id="logo-container">
            <img src="favicon.ico" alt="South Jerusalem Watch Logo" />
          </div>
          <h1 id="title" data-i18n="title"></h1>

          <div id="align-end">
            <button
              id="call-police"
              aria-pressed="false"
              aria-label="Call Police"
            >
              üëÆ
            </button>
            <button
              id="lang-toggle"
              aria-pressed="false"
              aria-label="Toggle language"
              data-i18n="toggle"
            ></button>
          </div>
          <button
            id="call-emergency-contact"
            aria-pressed="false"
            aria-label="Call Emergency Contact"
          >
            üìû
          </button>
        </div>
        <div id="status" role="status" aria-live="polite"></div>
      </header>

      <!-- New Home Page -->
      <section id="home" class="card">
        <ul>
          <li>
            <button
              class="home-button"
              id="user-information-card"
              data-i18n="userInformation"
            ></button>
          </li>
          <br />
          <li>
            <button
              class="home-button"
              id="report-card"
              data-i18n="reportIncident"
            ></button>
          </li>
          <br />
          <li>
            <button
              class="home-button"
              id="map-card"
              data-i18n="incidentMap"
            ></button>
          </li>
          <br />
          <li>
            <button
              class="home-button"
              id="about-card"
              data-i18n="about"
            ></button>
          </li>
        </ul>
      </section>

      <!-- Emergency Contact Section -->
      <section id="emergency-contact-section" class="card" hidden>
        <button class="back-button" data-i18n="back"></button>
        <label>
          <span data-i18n="emergencyContact"></span>
          <div class="inline-controls">
            <input id="user-emergency-contact" type="number" />
            <button id="save-emergency" type="button">üíæ</button>
            <button id="clear-emergency" type="button">üóë</button>
          </div>
        </label>
          <label>
            <span data-i18n="name"></span>
            <div class="inline-controls">
              <input
                id="user-name"
                type="text"
                autocomplete="name"
              />
              <button id="save-name" type="button">üíæ</button>
              <button id="clear-name" type="button">üóë</button>
            </div>
          </label>
          <label>
            <span data-i18n="age"></span>
            <div class="inline-controls">
              <input
                id="user-age"
                type="number"
              />
              <button id="save-age" type="button">üíæ</button>
              <button id="clear-age" type="button">üóë</button>
            </div>
          </label>
        </div>
      </section>

      <!--- Form entries-->
      <section class="card" id="form-section" hidden>
        <button class="back-button" data-i18n="back"></button>
        <label>
          <span data-i18n="reportIncident"></span>
        </label>
        <form
          id="form"
          action="https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/formResponse"
          method="POST"
          target="hidden_iframe"
        >
          <div class="form-grid">
            <!-- Name -->
            <div class="form-row">
              <label>
                <span data-i18n="name"></span>
                <div class="inline-controls">
                  <input
                    id="form-name"
                    type="text"
                    name="entry.1563137864"
                    autocomplete="name"
                  />
                </div>
              </label>
            </div>

            <!-- Age -->
            <div class="form-row">
              <label>
                <span data-i18n="age"></span>
                <div class="inline-controls">
                  <input
                    id="form-age"
                    type="number"
                    name="entry.552093736"
                    min="0"
                  />
                </div>
              </label>
            </div>

            <!-- Location -->
            <div class="form-row">
              <label>
                <span data-i18n="location"></span>
                <div class="inline-controls">
                  <input
                    id="location"
                    type="text"
                    name="entry.1771840150"
                    data-i18nplaceholder="currentLocation"
                    inputmode="text"
                  />
                  <button
                    type="button"
                    id="search-location"
                    data-i18n="searchLocation"
                    disabled
                  ></button>
                  <button
                    id="pin"
                    popovertarget="location-picker"
                    popovertargetaction="toggle"
                    type="button"
                  >
                    üìç
                  </button>
                  <div
                    id="location-picker"
                    popover
                    class="popover popover--wide"
                  >
                    <button
                      type="button"
                      class="popover-close"
                      popovertarget="location-picker"
                      popovertargetaction="hide"
                      aria-label="Close"
                    >
                      ‚úï
                    </button>
                    <div id="map-2"></div>
                  </div>
                </div>
              </label>
            </div>

            <!-- Date -->
            <div class="form-row">
              <label>
                <span data-i18n="date"></span>
                <input
                  id="form-date"
                  type="text"
                  onfocus="this.type = 'date'"
                  onblur="this.type = 'text'"
                  name="entry.123356142"
                  data-i18nplaceholder="currentDate"
                />
              </label>
            </div>

            <!-- Time -->
            <div class="form-row">
              <label>
                <span data-i18n="time"></span>
                <input
                  id="form-time"
                  type="text"
                  onfocus="this.type = 'time'"
                  onblur="this.type = 'text'"
                  name="entry.407216857"
                  data-i18nplaceholder="currentTime"
                />
              </label>
            </div>

            <!-- Type (Dropdown) -->
            <div class="form-row">
              <label>
                <span data-i18n="type"></span>
              </label>
              <button
                type="button"
                id="open-type-picker"
                popovertarget="type-picker"
                popovertargetaction="toggle"
                data-i18n="select"
              ></button>

              <div id="type-picker" popover class="popover popover--wide">
                <button
                  type="button"
                  class="popover-close"
                  popovertarget="type-picker"
                  popovertargetaction="hide"
                  aria-label="Close"
                >
                  ‚úï
                </button>
                <div class="popover-content">
                  <h3 data-i18n="typePickerTitle"></h3>
                  <ul class="option-list">
                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Disturbing staring"
                        />
                        <span data-i18n="disturbingStaring"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Following on foot"
                        />
                        <span data-i18n="followingOnFoot"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Following in car"
                        />
                        <span data-i18n="followingInCar"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Mocking or pointing"
                        />
                        <span data-i18n="mockingOrPointing"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Whistling or catcalling"
                        />
                        <span data-i18n="whistlingOrCatcalling"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Honking"
                        />
                        <span data-i18n="honking"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Yelling"
                        />
                        <span data-i18n="yelling"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Unwanted conversation attempt"
                        />
                        <span data-i18n="unwantedConversationAttempt"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Unwanted pickup attempt"
                        />
                        <span data-i18n="unwantedPickupAttempt"></span>
                      </label>
                    </li>

                    <li>
                      <label>
                        <input
                          type="checkbox"
                          name="entry.373709611"
                          value="Other"
                        />
                        <span data-i18n="other"></span>
                      </label>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Hidden container for generated inputs -->
              <input id="type-hidden-inputs" name="entry.373709611" hidden />
            </div>

            <!-- Description -->
            <div class="form-row">
              <label>
                <span data-i18n="description"></span>
                <textarea id="form-desc" name="entry.737097719"></textarea>
              </label>
            </div>

            <!-- Submit -->
            <div class="form-row">
              <button id="submitBtn" type="submit" data-i18n="submit"></button>
            </div>
          </div>
        </form>

        <div id="form-success" hidden data-i18n="success"></div>

        <iframe
          name="hidden_iframe"
          id="hidden_iframe"
          style="display: none"
        ></iframe>
        <button id="another-report" data-i18n="submitAnother" hidden></button>
      </section>

      <!-- Map section -->
      <section class="card" id="map-section" hidden>
        <button class="back-button" data-i18n="back"></button>
        <div id="map"></div>
      </section>

      <!-- About Section -->
      <section id="about-section" class="card" hidden>
        <button class="back-button" data-i18n="back"></button>
        <h2 data-i18n="about"></h2>
        <p data-i18n="desc"></p>
        <p data-i18n="installGuideIOS"></p>
        <p data-i18n="installGuideAndroid"></p>
      </section>

      <noscript class="card">
        <strong>JavaScript required for reporting and language toggle.</strong>
      </noscript>
    </main>

    <script>
      /* --- DOM helpers --- */
      const $ = (id) => document.getElementById(id);

      const els = {
        html: document.documentElement,
        offlineBanner: $("offline-banner"),
        status: $("status"),
        langToggle: $("lang-toggle"),
        form: $("form"),
        formName: $("form-name"),
        formAge: $("form-age"),
        location: $("location"),
        formDate: $("form-date"),
        formTime: $("form-time"),
        formDesc: $("form-desc"),
        submitButton: $("submitBtn"),
        successMessage: $("form-success"),
        anotherReport: $("another-report"),
        map: $("map"),
        searchLocation: $("search-location"),
        popover: $("location-picker"),
        map2: $("map-2"),
        buttons: {
          police: $("call-police"),
          emergency: $("call-emergency-contact"),
        },
        emergency: $("user-emergency-contact"),
        saveEmergency: $("save-emergency"),
        clearEmergency: $("clear-emergency"),
        name: $("user-name"),
        age: $("user-age"),
        saveName: $("save-name"),
        clearName: $("clear-name"),
        saveAge: $("save-age"),
        clearAge: $("clear-age"),
        typePicker: $("type-picker"),
        openBtn: $("open-type-picker"),
        hiddenInputs: $("type-hidden-inputs"),
      };

      /*********************************************************
       * CONFIG
       *********************************************************/

      const MAP_CENTER = [31.758837, 35.2]; // default map center
      const MAP_ZOOM = 13;

      const SHEET_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5GK9JffVcBGw4sN4Wda3jKCIdGBibjFMsHHIc1Xsc85sJvAVXson-B7v2L5imp-PdQy623QxA8J_R/pub?output=csv";

      /*********************************************************
       * SHARED LOADER
       *********************************************************/

      const LeafletLoader = (() => {
        let loaded = false;

        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }

        function loadCSS(href) {
          const l = document.createElement("link");
          l.rel = "stylesheet";
          l.href = href;
          document.head.appendChild(l);
        }

        async function load() {
          if (loaded) return;

          loadCSS("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css");

          await Promise.all([
            loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"),
            loadScript("https://unpkg.com/papaparse@5.4.1/papaparse.min.js"),
          ]);

          loaded = true;
        }

        return { load };
      })();

      class BaseMap {
        constructor(containerId, { center, zoom }) {
          this.containerId = containerId;
          this.center = center;
          this.zoom = zoom;
          this.map = null;
        }

        async init() {
          await LeafletLoader.load();

          this.map = L.map(this.containerId, {
            zoomControl: true,
          }).setView(this.center, this.zoom);

          this.tileLayer = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            { attribution: "&copy; OpenStreetMap contributors" },
          ).addTo(this.map);

          // One correct invalidate, after tiles exist
          this.tileLayer.once("load", () => {
            this.map.invalidateSize();
          });
        }
      }

      class WriteMap extends BaseMap {
        constructor(containerId, { center, zoom, onChange }) {
          super(containerId, { center, zoom });
          this.onChange = onChange;
          this.markerLayer = null;
          this.marker = null;
        }

        async init() {
          await super.init();

          this.markerLayer = L.layerGroup().addTo(this.map);

          // click handler to place marker
          this.map.on("click", (e) => {
            this.setMarker(e.latlng);
          });
        }

        clearMarker() {
          this.markerLayer.clearLayers();
        }

        setMarker(latlng) {
          // remove existing marker
          this.markerLayer.clearLayers();

          // add new marker
          this.marker = L.marker(latlng, {
            draggable: true,
            opacity: 0.85,
          }).addTo(this.markerLayer);

          // report location to callback
          this.emit(latlng);

          // update callback on drag
          this.marker.on("dragend", (ev) => {
            this.emit(ev.target.getLatLng());
          });
        }

        emit({ lat, lng }) {
          if (typeof this.onChange === "function") {
            this.onChange({ lat: +lat.toFixed(6), lng: +lng.toFixed(6) });
          }
        }
      }

      class ReadMap extends BaseMap {
        constructor(containerId, { center, zoom, sheetUrl }) {
          super(containerId, { center, zoom });
          this.sheetUrl = sheetUrl;
          this.incidentLayer = null;
        }

        async init() {
          await super.init();
          this.incidentLayer = L.layerGroup().addTo(this.map);
          this.loadIncidents();
        }

        escapeHTML(str) {
          return String(str).replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              })[c],
          );
        }

        normalizeRow(raw) {
          return {
            timestamp: raw["Timestamp"],
            name: raw["Your name (optional)"],
            age: raw["Age"],
            location: raw["Location of incident (address and/or coordinates) "],
            date: raw["Date of incident (YYYY-MM-DD)"],
            time: raw["Time of incident (HH:MM (24h))"],
            incident_type: raw["Type of incident "],
            description: raw["Description of incident and/or individuals"],
          };
        }

        buildPopup(row) {
          const fields = [
            ["Type", row.incident_type],
            ["Description", row.description],
            ["Date", row.date],
            ["Time", row.time],
            ["Location", row.location],
            ["Age", row.age],
            ["Reported by", row.name],
            ["Submitted", row.timestamp],
          ];

          return `
            <div class="popup">
              <table>
                ${fields
                  .map(
                    ([label, value]) => `
                  <tr><td><strong>${label}</strong></td><td>${this.escapeHTML(
                    value,
                  )}</td></tr>
                `,
                  )
                  .join("")}
              </table>
            </div>
          `;
        }

        async loadIncidents() {
          if (!this.sheetUrl) return;

          const res = await fetch(this.sheetUrl);
          const csvText = await res.text();

          const { data } = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
          });

          this.incidentLayer.clearLayers();
          data.map(this.normalizeRow).forEach((row) => this.addMarker(row));
        }

        addMarker(row) {
          if (!row.location) return;

          const [lat, lng] = row.location.split(",").map(Number);
          if (isNaN(lat) || isNaN(lng)) return;

          const popup = this.buildPopup(row);
          L.marker([lat, lng]).bindPopup(popup).addTo(this.incidentLayer);
        }
      }

      let readMap;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!els.map) return;

        readMap = new ReadMap("map", {
          center: MAP_CENTER,
          zoom: MAP_ZOOM,
          sheetUrl: SHEET_URL,
        });

        await readMap.init();
      });

      let writeMap;

      els.popover.addEventListener("toggle", (e) => {
        if (e.newState !== "open") {
          els.location.readOnly = false;
          els.location.inputMode = "text";
          return;
        }
        els.location.readOnly = true;
        els.location.inputMode = "none";
        els.location.blur(); // Remove focus if browser auto-focuses

        requestAnimationFrame(() => {
          // If map is already initialized, just invalidate and recenter
          if (writeMap) {
            writeMap.map.invalidateSize();

            const val = els.location.value;
            if (looksLikeCoordinates(val)) {
              const [lat, lng] = val.split(",").map(Number);
              writeMap.map.setView([lat, lng], MAP_ZOOM);
              writeMap.setMarker({ lat, lng });
            } else {
              writeMap.clearMarker();
              writeMap.map.setView(MAP_CENTER, MAP_ZOOM);
            }

            return;
          }

          // Otherwise, create the map
          writeMap = new WriteMap("map-2", {
            center: MAP_CENTER,
            zoom: MAP_ZOOM,
            onChange: ({ lat, lng }) => {
              els.location.value = `${lat}, ${lng}`;
            },
          });

          writeMap.init().then(() => {
            // After init, if input has valid coordinates, center + marker
            const val = els.location.value;
            if (looksLikeCoordinates(val)) {
              const [lat, lng] = val.split(",").map(Number);
              writeMap.map.setView([lat, lng], MAP_ZOOM);
              writeMap.setMarker({ lat, lng });
            }
          });
        });
      });

      function looksLikeCoordinates(value) {
        return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test(value);
      }

      async function geocodeLocationText(text) {
        const url =
          "https://nominatim.openstreetmap.org/search?" +
          new URLSearchParams({
            q: text,
            format: "json",
            limit: 1,
            countrycodes: "il",
            viewbox: "35.14389,31.712372,35.287743,31.868845",
            bounded: 1,
          });

        const res = await fetch(url, {
          headers: {
            Accept: "application/json",
            "User-Agent": "SJWatch/1.0 (jonahhessdev@gmail.com)",
          },
        });

        if (!res.ok) return null;

        const results = await res.json();
        if (!results.length) return null;

        const lat = Number(results[0].lat);
        const lng = Number(results[0].lon);

        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }

      /* --- Constants --- */
      const GOOGLE_FORM_BASE =
        "https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true";
      const POLICE_NUMBER = "100";

      const KEYS = {
        name: "sjw-user-name",
        age: "sjw-user-age",
        emergency: "sjw-user-emergency-contact",
      };

      /* --- Translations --- */
      const translations = {
        en: {
          title: "South JLM Watch",
          offline:
            "‚ö†Ô∏è Offline mode: Reporting and map viewing require an internet connection.",
          toggle: "üáÆüá±",
          saved: "saved",
          cleared: "cleared",
          incidentMap: "Incident Map",
          back: "Back",
          userInformation: "User Information",
          emergencyContact: "Emergency Contact",
          reportIncident: "Report an Incident",
          name: "Name",
          age: "Age",
          location: "Location",
          searchLocation: "üîé",
          date: "Date",
          time: "Time",
          type: "Incident Type",
          select: "Select incident type(s)",
          selected: "Selected",
          description: "Description",
          submit: "Submit",
          submitAnother: "Submit another report",
          prefillHint:
            "The form will be prefilled with your location, cached name & age, and the current date/time.",
          about: "About",
          desc: "This is a website dedicated to keeping kids safe on the streets.",
          privacy:
            "No authentication. Public data only. Do not include personal or sensitive information.",
          typePickerTitle: "Select all that apply",
          disturbingStaring: "Disturbing staring",
          followingOnFoot: "Following on foot",
          followingInCar: "Following in car",
          mockingOrPointing: "Mocking or pointing",
          whistlingOrCatcalling: "Whistling or catcalling",
          honking: "Honking",
          yelling: "Yelling",
          unwantedConversationAttempt: "Unwanted conversation attempt",
          unwantedPickupAttempt: "Unwanted pickup attempt",
          other: "Other (describe below)",
          done: "Done",
          installGuideIOS:
            "To install on iOS: From the browser, click the 3 dots icon, Share, More, Add to home screen, (open as web app selected) and press Add.",
          installGuideAndroid:
            "To install on Android: From the browser, click the 3 dots icon and select Add to home screen.",
        },
        he: {
          title: "◊û◊©◊û◊® ◊ì◊®◊ï◊ù ◊ô◊®◊ï◊©◊ú◊ô◊ù",
          offline: "‚ö†Ô∏è ◊ú◊ê ◊û◊ó◊ï◊ë◊® ◊ú◊ê◊ô◊†◊ò◊®◊†◊ò. ◊î◊ò◊ï◊§◊° ◊ï◊î◊û◊§◊î ◊ú◊ê ◊ô◊¢◊ë◊ì◊ï.",
          toggle: "üá∫üá∏",
          saved: "◊†◊©◊û◊®",
          cleared: "◊†◊û◊ó◊ß",
          incidentMap: "◊û◊§◊™ ◊™◊ß◊®◊ô◊ï◊™",
          back: "◊ê◊ó◊ï◊®◊î",
          userInformation: "◊î◊û◊ô◊ì◊¢ ◊©◊ú◊ô",
          emergencyContact: "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù",
          reportIncident: "◊ò◊ï◊§◊° ◊ú◊î◊í◊©◊™ ◊™◊ú◊ï◊†◊î",
          name: "◊©◊ù",
          age: "◊í◊ô◊ú",
          location: "◊û◊ô◊ß◊ï◊ù",
          searchLocation: "üîç",
          date: "◊™◊ê◊®◊ô◊ö",
          time: "◊ñ◊û◊ü",
          type: "◊°◊ï◊í ◊™◊ß◊®◊ô◊™",
          select: "◊ë◊ó◊®◊ï ◊û◊™◊ï◊ö ◊î◊ê◊ï◊§◊¶◊ô◊ï◊™ ◊î◊ë◊ê◊ï◊™",
          selected: "◊†◊ë◊ó◊®◊ï",
          description: "◊î◊°◊ë◊®",
          submit: "◊î◊í◊©◊™ ◊™◊ú◊ï◊†◊î",
          submitAnother: "◊ú◊î◊í◊ô◊© ◊¢◊ï◊ì ◊™◊ú◊ï◊†◊î",
          prefillHint: "◊î◊ò◊ï◊§◊° ◊ô◊û◊ï◊ú◊ê ◊ë◊û◊ô◊ß◊ï◊ù, ◊©◊ù ◊ï◊í◊ô◊ú ◊ï◊©◊¢◊™/◊™◊ê◊®◊ô◊ö ◊î◊ì◊ô◊ï◊ï◊ó.",
          about: "◊ê◊ï◊ì◊ï◊™",
          desc: "◊ñ◊î ◊ê◊™◊® ◊©◊û◊ï◊ß◊ì◊© ◊ú◊©◊û◊ô◊®◊î ◊¢◊ú ◊ô◊ú◊ì◊ô◊†◊ï ◊ë◊®◊ó◊ï◊ë.",
          privacy:
            "◊ú◊ú◊ê ◊ê◊ô◊û◊ï◊™. ◊†◊™◊ï◊†◊ô◊ù ◊í◊ú◊ï◊ô◊ô◊ù ◊ú◊¶◊ô◊ë◊ï◊® ◊ë◊ú◊ë◊ì. ◊ê◊ú ◊™◊õ◊ú◊ú◊ï ◊û◊ô◊ì◊¢ ◊ê◊ô◊©◊ô ◊ê◊ï ◊®◊í◊ô◊©.",
          typePickerTitle: "◊ë◊ó◊®/◊ô ◊ê◊™ ◊õ◊ú ◊î◊ê◊§◊©◊®◊ï◊ô◊ï◊™ ◊î◊û◊™◊ê◊ô◊û◊ï◊™",
          disturbingStaring: "◊ë◊î◊ô◊ô◊î ◊û◊ò◊®◊ô◊ì◊î",
          followingOnFoot: "◊û◊¢◊ß◊ë ◊®◊í◊ú◊ô",
          followingInCar: "◊û◊¢◊ß◊ë ◊ë◊®◊õ◊ë",
          mockingOrPointing: "◊ú◊¢◊í ◊ê◊ï ◊î◊¶◊ë◊¢◊î",
          whistlingOrCatcalling: "◊©◊®◊ô◊ß◊ï◊™ ◊ê◊ï ◊ß◊®◊ô◊ê◊ï◊™",
          honking: "◊¶◊§◊ô◊®◊î",
          yelling: "◊¶◊¢◊ß◊ï◊™",
          unwantedConversationAttempt: "◊†◊ô◊°◊ô◊ï◊ü ◊©◊ô◊ó◊î ◊ú◊ê ◊®◊¶◊ï◊ô",
          unwantedPickupAttempt: "◊†◊ô◊°◊ô◊ï◊ü ◊î◊™◊ó◊ú◊î ◊ú◊ê ◊®◊¶◊ï◊ô",
          other: "◊ê◊ó◊® (◊§◊ô◊®◊ï◊ò ◊ú◊û◊ò◊î)",
          done: "◊°◊ô◊ô◊ù",
          installGuideIOS:
            "◊ú◊î◊™◊ß◊ô◊ü ◊¢◊ú ◊ê◊ô◊ô◊§◊ï◊ü: ◊ë◊ì◊§◊ì◊§◊ü ◊ú◊ï◊ó◊¶◊ô◊ù ◊¢◊ú 3 ◊†◊ß◊ï◊ì◊ï◊™, ◊©◊™◊£, ◊¢◊ï◊ì, ◊î◊ï◊°◊£ ◊ú◊ì◊£ ◊î◊ë◊ô◊™, ◊ï◊î◊ï◊°◊£.",
          installGuideAndroid:
            "◊ú◊î◊™◊ß◊ô◊ü ◊¢◊ú ◊ê◊†◊ì◊®◊ï◊ô◊ì: ◊ë◊ì◊§◊ì◊§◊ü ◊ú◊ï◊ó◊¶◊ô◊ù ◊¢◊ú ◊ê◊§◊©◊®◊ï◊ô◊ï◊™ ◊ï◊ë◊ï◊ó◊®◊ô◊ù ◊î◊ï◊°◊£ ◊ú◊ì◊£ ◊î◊ë◊ô◊™.",
        },
      };

      const placeholders = {
        en: {
          currentLocation: "Current Location",
          currentDate: "Current Date",
          currentTime: "Current Time",
        },
        he: {
          currentLocation: "◊û◊ô◊ß◊ï◊ù ◊†◊ï◊õ◊ó◊ô",
          currentDate: "◊™◊ê◊®◊ô◊ö ◊¢◊ì◊õ◊†◊ô",
          currentTime: "◊ñ◊û◊ü ◊†◊ï◊õ◊ó◊ô",
        },
      };

      /* --- Status --- */
      function showStatus(text, ms = 3000) {
        if (!els.status) return;
        els.status.textContent = text;
        clearTimeout(showStatus._t);
        if (ms > 0)
          showStatus._t = setTimeout(() => (els.status.textContent = ""), ms);
      }

      /* --- Language --- */
      let currentLang = localStorage.getItem("sjw-lang") || "he";
      function updateText(lang) {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.dataset.i18n;
          if (translations[lang] && translations[lang][key])
            el.textContent = translations[lang][key];
        });
        document.querySelectorAll("[data-i18nplaceholder]").forEach((el) => {
          const key = el.dataset.i18nplaceholder;
          if (placeholders[lang] && placeholders[lang][key])
            el.placeholder = placeholders[lang][key];
        });

        updateButtonText();
      }

      function applyLang(lang) {
        currentLang = lang;
        els.html.lang = lang;
        els.html.dir = lang === "he" ? "rtl" : "ltr";
        localStorage.setItem("sjw-lang", lang);
        updateText(lang);
        els.langToggle.setAttribute("aria-pressed", lang === "he");
      }

      els.langToggle.addEventListener("click", () =>
        applyLang(currentLang === "en" ? "he" : "en"),
      );
      els.langToggle.addEventListener("keydown", (e) => {
        if (["Enter", " "].includes(e.key)) {
          e.preventDefault();
          e.target.click();
        }
      });

      /* --- User cache --- */
      function loadUser() {
        els.name.value = localStorage.getItem(KEYS.name) || "";
        els.age.value = localStorage.getItem(KEYS.age) || "";
        els.emergency.value = localStorage.getItem(KEYS.emergency) || "";
      }

      function saveName() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.name, val)
          : localStorage.removeItem(KEYS.name);

        showStatus(currentLang === "en" ? "Name saved" : "◊î◊©◊ù ◊†◊©◊û◊®", 2000);
        updateNameState();
      }

      function clearName() {
        if (localStorage.getItem(KEYS.name) === null) return;

        localStorage.removeItem(KEYS.name);
        els.name.value = "";

        showStatus(currentLang === "en" ? "Name cleared" : "◊î◊©◊ù ◊†◊û◊ó◊ß", 2000);
        updateNameState();
      }

      function saveAge() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.age, val)
          : localStorage.removeItem(KEYS.age);

        showStatus(currentLang === "en" ? "Age saved" : "◊í◊ô◊ú ◊†◊©◊û◊®", 2000);
        updateAgeState();
      }

      function clearAge() {
        if (localStorage.getItem(KEYS.age) === null) return;

        localStorage.removeItem(KEYS.age);
        els.age.value = "";

        showStatus(currentLang === "en" ? "Age cleared" : "◊í◊ô◊ú ◊†◊û◊ó◊ß", 2000);
        updateAgeState();
      }

      function saveEmergency() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.emergency, val)
          : localStorage.removeItem(KEYS.emergency);

        showStatus(
          currentLang === "en"
            ? "Emergency contact saved"
            : "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù ◊†◊©◊û◊®",
          2000,
        );
        updateEmergencyState();
      }

      function clearEmergency() {
        if (localStorage.getItem(KEYS.emergency) === null) return;

        localStorage.removeItem(KEYS.emergency);
        els.emergency.value = "";

        showStatus(
          currentLang === "en"
            ? "Emergency contact cleared"
            : "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù ◊†◊û◊ó◊ß",
          2000,
        );
        updateEmergencyState();
      }

      function updateNameState() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || "";

        els.saveName.disabled = val === stored;
        els.clearName.disabled = stored === "";
      }

      function updateAgeState() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || "";

        els.saveAge.disabled = val === stored;
        els.clearAge.disabled = stored === "";
      }

      function updateEmergencyState() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || "";

        els.saveEmergency.disabled = val === stored;
        els.clearEmergency.disabled = stored === "";
        els.buttons.emergency.disabled = !stored;
      }

      els.saveName.addEventListener("click", saveName);
      els.clearName.addEventListener("click", clearName);

      els.saveAge.addEventListener("click", saveAge);
      els.clearAge.addEventListener("click", clearAge);

      els.saveEmergency.addEventListener("click", saveEmergency);
      els.clearEmergency.addEventListener("click", clearEmergency);

      els.name.addEventListener("input", updateNameState);
      els.age.addEventListener("input", updateAgeState);
      els.emergency.addEventListener("input", updateEmergencyState);

      /* --- Call buttons --- */
      els.buttons.police.addEventListener(
        "click",
        () => (window.location.href = `tel:${POLICE_NUMBER}`),
      );

      els.buttons.emergency.addEventListener("click", () => {
        const number = localStorage.getItem(KEYS.emergency);
        window.location.href = `tel:${number}`;
      });

      // /* --- Offline Detection --- */
      function updateOnlineStatus() {
        els.offlineBanner.hidden = navigator.onLine;
        els.submitButton.disabled = !navigator.onLine;
      }

      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);

      els.typePicker.addEventListener("toggle", (e) => {
        if (!els.typePicker.matches(":popover-open")) {
          updateButtonText();
        }
      });

      function updateButtonText() {
        const checked = document.querySelectorAll(
          'input[name="entry.373709611"]:checked',
        );

        if (checked.length === 0) {
          els.openBtn.textContent = translations[currentLang].select;
        } else if (checked.length === 1) {
          els.openBtn.textContent = checked[0].nextElementSibling.textContent;
        } else {
          els.openBtn.textContent =
            translations[currentLang].selected + " " + checked.length;
        }
      }

      const getLocation = () =>
        new Promise((resolve) => {
          if (!navigator.geolocation) return resolve("unknown");

          navigator.geolocation.getCurrentPosition(
            (pos) => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`),
            (err) => {
              console.warn("Geolocation error:", err);
              resolve("unknown");
            },
            {
              enableHighAccuracy: true, // try for more precise location
              timeout: 5000, // wait up to 5 seconds
              maximumAge: 0, // don't use cached location
            },
          );
        });

      function resetIncidentTypes() {
        const checkboxes = document.querySelectorAll(
          'input[name="entry.373709611"]',
        );

        checkboxes.forEach((cb) => {
          cb.checked = false;
        });

        updateButtonText();
      }

      async function finalizeSubmit() {
        els.form.submit();
        els.form.style.display = "none";
        els.successMessage.hidden = false;
        els.anotherReport.hidden = false;
        resetIncidentTypes();
        setTimeout(await readMap.loadIncidents(), 10000);
      }

      els.form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const now = new Date();

        // Fill if empty
        els.formName.value ||= els.name.value || ""
        els.formAge.value ||= els.age.value || "" 
        els.formDate.value ||= now.toISOString().split("T")[0];
        els.formTime.value ||= now.toTimeString().slice(0, 5);

        // Fill location or convert text ‚Üí coordinates
        if (!els.location.value) {
          els.location.value = await getLocation();
        } else if (!looksLikeCoordinates(els.location.value)) {
          const coords = await geocodeLocationText(els.location.value);
          if (!coords) {
            alert("Could not resolve location. Please be more specific.");
            return;
          }
          els.location.value = coords;
        }

        // add incidents to form
        const checked = document.querySelectorAll(
          'input[name="entry.373709611"]:checked',
        );

        els.hiddenInputs.value = Array.from(checked)
          .map((option) => option.value)
          .join(", ");
        finalizeSubmit();
      });

      els.anotherReport.addEventListener("click", () => {
        els.form.style.display = "block";
        els.successMessage.hidden = true;
        els.anotherReport.hidden = true;
        els.location.value = "";
        els.formDate.value = "";
        els.formDate.type = "text";
        els.formTime.value = "";
        els.formTime.type = "text";
        els.formDesc.value = "";

        resumed = false;
      });

      els.searchLocation.addEventListener("click", async () => {
        els.location.value = await geocodeLocationText(els.location.value);
        els.searchLocation.disabled = true;
      });

      function isLikelySearchableQuery(input) {
        if (typeof input !== "string") return false;

        const s = input.trim();
        if (!s) return false;

        // Reject pure numbers
        if (/^\p{N}+$/u.test(s)) return false;

        // Must contain at least one letter
        if (!/\p{L}/u.test(s)) return false;
        return true;
      }

      els.location.addEventListener("input", () => {
        els.searchLocation.disabled = !isLikelySearchableQuery(
          els.location.value,
        );
      });

      els.location.addEventListener("click", () => {
        els.location.inputMode = "text";
        els.location.readOnly = false;
      });

      function updateFormState() {
        els.formName.placeholder = els.name.value;
        els.formAge.placeholder = els.age.value;
      }

      /* --- New Home Page --- */
      document.querySelectorAll(".home-button").forEach(
        (btn) =>
          (btn.onclick = () => {
            document
              .querySelectorAll(".card")
              .forEach((card) => (card.hidden = true));
            switch (btn.id) {
              case "user-information-card": {
                document.getElementById("emergency-contact-section").hidden =
                  false;
                break;
              }
              case "report-card": {
                updateFormState()
                document.getElementById("form-section").hidden = false;
                break;
              }
              case "map-card": {
                document.getElementById("map-section").hidden = false;
                readMap.map.invalidateSize();
                break;
              }
              case "about-card": {
                document.getElementById("about-section").hidden = false;
                break;
              }
              default: {
                console.log(btn.id);
              }
            }
          }),
      );

      document.querySelectorAll(".back-button").forEach(
        (btn) =>
          (btn.onclick = () => {
            document
              .querySelectorAll(".card")
              .forEach((card) => (card.hidden = true));
            document.getElementById("home").hidden = false;
          }),
      );

      /* --- Init --- */
      loadUser();
      updateNameState();
      updateAgeState();
      updateEmergencyState();
      updateOnlineStatus();
      applyLang(currentLang);

      /* --- Service Worker --- */
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/jwatch/sw.js", { scope: "/jwatch/" })
            .then((reg) => console.log("SW registered:", reg.scope))
            .catch((err) => console.warn("SW register failed:", err));
        });
      }
    </script>
  </body>
</html>
