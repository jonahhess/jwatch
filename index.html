<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="South Jerusalem Watch" />
    <meta name="theme-color" content="#0f172a" />

    <!-- iOS PWA -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SJ Watch" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png" />

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" href="/favicon-16x16.png" type="image/png" />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Manifest -->
    <link rel="canonical" href="https://jonahhess.github.io/jwatch/" />
    <link
      rel="manifest"
      href="https://jonahhess.github.io/jwatch/manifest.json"
    />

    <title>South Jerusalem Watch</title>

    <style>
      :root {
        /* Spacing scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 1rem;
        --space-4: 1.5rem;
        --space-5: 2rem;

        /* Typography */
        --font-base: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, Helvetica, Arial, sans-serif;

        --text-base: 1rem;
        --text-small: 0.875rem;
        --text-large: 1.25rem;

        /* Colors (neutral on purpose) */
        --color-bg: #f7f7f7;
        --color-surface: #ffffff;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-accent: #0a66c2;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html {
        font-family: var(--font-base);
        font-size: 100%;
        line-height: 1.5;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
        max-width: 900px;
        margin: auto;
        -webkit-text-size-adjust: 100%;
      }

      .title-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
        column-gap: 0.75rem;
        align-items: center;
      }

      /* Logo: align with title row only */
      #logo-container {
        grid-column: 1;
        grid-row: 1;
        margin-top: 0.75rem;
      }

      #logo-container img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        display: block;
      }

      /* Title */
      .title-meta h1 {
        grid-column: 2;
        grid-row: 1;

        margin: 0;
        font-size: 1.25rem;
        line-height: 1.2;
      }

      /* Meta text below title */
      .title-meta .meta {
        grid-column: 2;
        grid-row: 2;

        font-size: 0.875rem;
        color: #666;
      }

      section {
        margin: var(--space-2);
      }

      .container {
        padding-left: var(--space-3);
        padding-right: var(--space-3);
      }

      .offline-banner {
        background-color: #fffbcc; /* light yellow */
        color: #333;
        padding: var(--space-2) var(--space-3);
        text-align: center;
        font-size: var(--text-small);
        border-bottom: 1px solid #f0e68c;
        position: sticky;
        top: 0;
        z-index: 1001;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .meta {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      header {
        position: relative; /* keep for layout */
        z-index: 0; /* ensure popover is above */
        overflow: visible; /* most common culprit */
      }

      button {
        font: inherit;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        -webkit-tap-highlight-color: initial;
      }

      #emergency {
        display: flex;
        width: 100%;
        gap: var(--space-1);
      }

      #status {
        min-height: var(--space-4);
        margin-top: var(--space-2);
      }

      .card {
        background: var(--color-surface);
        border-radius: 0.75rem;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
      }

      .muted {
        color: var(--color-muted);
      }

      .hint {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      label {
        font-size: var(--text-small);
      }

      input {
        font: inherit;
        padding: var(--space-2);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
      }

      html[dir='rtl'] {
        direction: rtl;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: 1rem;
      }

      .form-row {
        width: 100%;
      }

      label span {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      input,
      textarea,
      select,
      button {
        width: 100%;
        font-size: 1rem;
        padding: 0.6rem;
      }

      .inline-controls {
        display: flex;
        gap: var(--space-2);
      }

      select[multiple] {
        min-height: 8rem;
      }

      .picker-button {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
      }

      /* Hide when closed */
      dialog:not([open]) {
        display: none;
      }

      /* Let the browser control positioning */
      dialog {
        border: none;
        padding: 1rem;
        border-radius: 12px;

        width: min(90vw, 480px);
        max-height: 80vh;

        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      /* Backdrop */
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.4);
      }

      /* Reset list appearance */
      .option-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      /* Each option */
      .option-list li {
        margin-bottom: 0.5rem;
      }

      /* Make the whole row clickable */
      .option-list label {
        display: flex;
        align-items: center;
        gap: 0.75rem;

        padding: 0.75rem 1rem;
        border-radius: 8px;
        cursor: pointer;

        background: #fff;
        border: 1px solid #ddd;

        transition: background 0.2s, border-color 0.2s;
      }

      /* Hide native checkbox but keep it accessible */
      .option-list input[type='checkbox'] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      /* Hover effect (matches old li:hover) */
      .option-list label:hover {
        background: #f5f7fa;
      }

      /* Selected state (matches old .selected) */
      .option-list input:checked + span {
        font-weight: 600;
      }

      .option-list input:checked + span::before {
        content: 'âœ“';
        display: inline-block;
        margin-inline-end: 0.5rem;
      }

      /* Keyboard focus */
      .option-list input:focus-visible + span {
        outline: 2px so;
      }

      #map {
        height: 400px;
        width: 100%;
        margin-bottom: 0.75rem;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      #user-emergency-contact:disabled {
        opacity: 0.6;
        color: #cccccc;
      }
      #submit-button {
        color: black;
      }
    </style>
  </head>

  <body>
    <main class="container" id="main">
      <div
        id="offline-banner"
        class="offline-banner muted"
        hidden
        data-i18n="offline"
      ></div>

      <header>
        <div class="title-meta">
          <div id="logo-container">
            <img src="favicon.ico" alt="South Jerusalem Watch Logo" />
          </div>
          <h1 data-i18n="title"></h1>
          <div class="meta" data-i18n="meta"></div>
        </div>

        <div id="status" role="status" aria-live="polite"></div>

        <section class="card">
          <label>
            <span data-i18n="emergencyContact"></span>
            <div id="emergency">
              <input
                id="user-emergency-contact"
                type="tel"
                pattern="/d{3}-/d{3}-/d{4}"
              />
              <button
                id="save-emergency"
                type="button"
                data-i18n="save"
              ></button>
              <button
                id="clear-emergency"
                type="button"
                data-i18n="clear"
              ></button>
              <button
                id="call-emergency-contact"
                class="call-button"
                aria-pressed="false"
                aria-label="Call Emergency Contact"
              >
                ðŸ“ž
              </button>
            </div>
          </label>
        </section>

        <section class="card inline-controls" id="button-section">
          <button
            id="call-police"
            class="call-button"
            aria-pressed="false"
            aria-label="Call Police"
            data-i18n="callPolice"
          ></button>
          <button
            id="lang-toggle"
            aria-pressed="false"
            aria-label="Toggle language"
            data-i18n="toggle"
          ></button>
        </section>
      </header>

      <!--- Form entries-->
      <section class="card" id="form-section">
        <form
          id="google-form"
          action="https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/formResponse"
          method="POST"
          target="hidden_iframe"
        >
          <div class="form-grid">
            <!-- Name -->
            <div class="form-row">
              <label>
                <span data-i18n="name"></span>
                <div class="inline-controls">
                  <input
                    id="user-name"
                    type="text"
                    name="entry.1563137864"
                    autocomplete="name"
                  />
                  <button
                    id="save-name"
                    type="button"
                    data-i18n="save"
                  ></button>
                  <button
                    id="clear-name"
                    type="button"
                    data-i18n="clear"
                  ></button>
                </div>
              </label>
            </div>

            <!-- Age -->
            <div class="form-row">
              <label>
                <span data-i18n="age"></span>
                <div class="inline-controls">
                  <input
                    id="user-age"
                    type="number"
                    name="entry.552093736"
                    min="0"
                    value="0"
                  />
                  <button id="save-age" type="button" data-i18n="save"></button>
                  <button
                    id="clear-age"
                    type="button"
                    data-i18n="clear"
                  ></button>
                </div>
              </label>
            </div>

            <!-- Location -->
            <div class="form-row">
              <label>
                <span data-i18n="location"></span>
                <input
                  id="location"
                  type="text"
                  name="entry.1771840150"
                  data-i18nplaceholder="currentLocation"
                />
              </label>
            </div>

            <!-- Date -->
            <div class="form-row">
              <label>
                <span data-i18n="date"></span>
                <input
                  id="form-date"
                  type="text"
                  name="entry.123356142"
                  data-i18nplaceholder="currentDate"
                />
              </label>
            </div>

            <!-- Time -->
            <div class="form-row">
              <label>
                <span data-i18n="time"></span>
                <input
                  id="form-time"
                  type="text"
                  name="entry.407216857"
                  data-i18nplaceholder="currentTime"
                />
              </label>
            </div>

            <!-- Type (Dropdown) -->
            <div class="form-row">
              <label>
                <span data-i18n="type"></span>
                <button
                  type="button"
                  id="open-type-picker"
                  class="picker-button"
                  data-i18n="select"
                ></button>
              </label>

              <!-- Hidden container for generated inputs -->
              <div id="type-hidden-inputs"></div>
            </div>

            <!-- Description -->
            <div class="form-row">
              <label>
                <span data-i18n="description"></span>
                <textarea id="form-desc" name="entry.737097719"></textarea>
              </label>
            </div>

            <!-- Submit -->
            <div class="form-row">
              <button
                id="submit-button"
                type="submit"
                data-i18n="submit"
              ></button>
            </div>
          </div>
        </form>

        <div id="form-success" hidden data-i18n="success"></div>

        <iframe
          name="hidden_iframe"
          id="hidden_iframe"
          style="display: none"
        ></iframe>
      </section>

      <button id="another-report" data-i18n="submitAnother" hidden></button>

      <!-- Map section -->
      <section class="card" id="map-section">
        <div id="map"></div>
        <div class="hint" data-i18n="mapHint"></div>
      </section>
      <section id="about-section" class="card">
        <h2 data-i18n="about"></h2>
        <p data-i18n="desc"></p>
      </section>

      <noscript class="card">
        <strong>JavaScript required for reporting and language toggle.</strong>
      </noscript>

      <!-- Dialog -->
      <dialog id="type-modal">
        <div class="modal-sheet">
          <h3 data-i18n="typeModalTitle"></h3>

          <ul class="option-list">
            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="disturbingStaring"
                />
                <span data-i18n="disturbingStaring"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="followingOnFoot"
                />
                <span data-i18n="followingOnFoot"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="followingInCar"
                />
                <span data-i18n="followingInCar"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="mockingOrPointing"
                />
                <span data-i18n="mockingOrPointing"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="whistlingOrCatcalling"
                />
                <span data-i18n="whistlingOrCatcalling"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="honking" />
                <span data-i18n="honking"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="yelling" />
                <span data-i18n="yelling"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="unwantedConversationAttempt"
                />
                <span data-i18n="unwantedConversationAttempt"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="unwantedPickupAttempt"
                />
                <span data-i18n="unwantedPickupAttempt"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="other" />
                <span data-i18n="other"></span>
              </label>
            </li>
          </ul>

          <button
            type="button"
            id="close-type-picker"
            data-i18n="done"
          ></button>
        </div>
      </dialog>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      /* --- DOM helpers --- */
      const $ = id => document.getElementById(id);

      const els = {
        html: document.documentElement,
        main: $('main'),
        offlineBanner: $('offline-banner'),
        status: $('status'),
        userToggle: $('user-info-toggle'),
        userContent: $('user-info-content'),
        langToggle: $('lang-toggle'),
        formSection: $('form-section'),
        form: $('google-form'),
        location: $('location'),
        formDate: $('form-date'),
        formTime: $('form-time'),
        formDesc: $('form-desc'),
        submitButton: $('submit-button'),
        successMessage: $('form-success'),
        anotherReport: $('another-report'),
        map: $('map'),
        buttons: {
          police: $('call-police'),
          emergency: $('call-emergency-contact')
        },
        name: $('user-name'),
        age: $('user-age'),
        saveName: $('save-name'),
        clearName: $('clear-name'),
        saveAge: $('save-age'),
        clearAge: $('clear-age'),
        emergency: $('user-emergency-contact'),
        saveEmergency: $('save-emergency'),
        clearEmergency: $('clear-emergency'),
        modal: $('type-modal'),
        openBtn: $('open-type-picker'),
        closeBtn: $('close-type-picker'),
        listItems: document.querySelectorAll('.option-list li'),
        hiddenInputs: $('type-hidden-inputs')
      };

      /*********************************************************
       * CONFIG
       *********************************************************/

      const MAP_CENTER = [31.758837, 35.2]; // default map center
      const MAP_ZOOM = 13;

      const SHEET_URL =
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5GK9JffVcBGw4sN4Wda3jKCIdGBibjFMsHHIc1Xsc85sJvAVXson-B7v2L5imp-PdQy623QxA8J_R/pub?output=csv';

      /*********************************************************
       * STATE
       *********************************************************/

      let mapInitialized = false;
      let map;
      let incidentLayer;
      let draftLayer;
      let draftMarker;

      /*********************************************************
       * UTILITIES
       *********************************************************/

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }

      function loadCSS(href) {
        const l = document.createElement('link');
        l.rel = 'stylesheet';
        l.href = href;
        document.head.appendChild(l);
      }

      function updateLocationInput(lat, lng) {
        if (!els.location) return;
        els.location.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }

      /*********************************************************
       * MAP INITIALIZATION
       *********************************************************/

      async function initMap() {
        if (mapInitialized) return;
        mapInitialized = true;

        // Load Leaflet assets
        loadCSS('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
        await Promise.all([
          loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'),
          loadScript('https://unpkg.com/papaparse@5.4.1/papaparse.min.js')
        ]);

        // Create map
        map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Layers
        incidentLayer = L.layerGroup().addTo(map);
        draftLayer = L.layerGroup().addTo(map);

        // Load incidents
        loadIncidents();

        // Enable draft marker placement
        enableDraftMarker();

        // Fix size if container was hidden
        setTimeout(() => map.invalidateSize(), 0);
      }

      /*********************************************************
       * DATA LOADING (READ SIDE)
       *********************************************************/

      function normalizeRow(raw) {
        return {
          timestamp: raw['Timestamp'],
          name: raw['Your name (optional)'],
          age: raw['Age'],
          location: raw['Location of incident (address and/or coordinates) '],
          date: raw['Date of incident (YYYY-MM-DD)'],
          time: raw['Time of incident (HH:MM (24h))'],
          incident_type: raw['Type of incident '],
          description: raw['Description of incident and/or individuals']
        };
      }

      function escapeHTML(str) {
        return String(str).replace(
          /[&<>"']/g,
          c =>
            ({
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;'
            }[c])
        );
      }

      function parseCSV(csvText) {
        const result = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true
        });
        return result.data;
      }

      function buildIncidentPopup(row) {
        const fields = [
          ['Type', row.incident_type],
          ['Description', row.description],
          ['Date', row.date],
          ['Time', row.time],
          ['Location', row.location],
          ['Age', row.age],
          ['Reported by', row.name],
          ['Submitted', row.timestamp]
        ];

        return `
    <div class="popup">
      <strong>${row.incident_type || 'Incident'}</strong>
      <table>
        ${fields
          .filter(([, value]) => value)
          .map(
            ([label, value]) => `
              <tr>
                <td><strong>${label}</strong></td>
                <td>${escapeHTML(value)}</td>
              </tr>
            `
          )
          .join('')}
      </table>
    </div>
  `;
      }

      function loadIncidents() {
        if (!SHEET_URL) return;

        fetch(SHEET_URL)
          .then(res => res.text())
          .then(csv => {
            parseCSV(csv).forEach(row => addIncidentMarker(normalizeRow(row)));
          })
          .catch(err => console.error('Incident load failed:', err));
      }

      function addIncidentMarker(row) {
        if (!row.location) return;

        const [lat, lng] = row.location.split(',').map(Number);
        if (isNaN(lat) || isNaN(lng)) return;

        const popup = buildIncidentPopup(row);

        L.marker([lat, lng]).bindPopup(popup).addTo(incidentLayer);
      }

      /*********************************************************
       * DRAFT MARKER (WRITE SIDE)
       *********************************************************/

      function enableDraftMarker() {
        map.on('click', e => {
          const { lat, lng } = e.latlng;

          draftLayer.clearLayers();

          draftMarker = L.marker([lat, lng], {
            draggable: true,
            opacity: 0.85
          }).addTo(draftLayer);

          updateLocationInput(lat, lng);

          draftMarker.on('dragend', ev => {
            const pos = ev.target.getLatLng();
            updateLocationInput(pos.lat, pos.lng);
          });
        });
      }

      /*********************************************************
       * LAZY LOAD TRIGGER
       *********************************************************/

      document.addEventListener('DOMContentLoaded', () => {
        if (!els.map) return;

        const observer = new IntersectionObserver(
          entries => {
            if (entries[0].isIntersecting) {
              initMap();
              observer.disconnect();
            }
          },
          { rootMargin: '200px' }
        );

        observer.observe(els.map);
      });

      function looksLikeCoordinates(value) {
        return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test(value);
      }

      async function geocodeLocationText(text) {
        const url =
          'https://nominatim.openstreetmap.org/search?' +
          new URLSearchParams({
            q: text,
            format: 'json',
            limit: 1
          });

        const res = await fetch(url, {
          headers: {
            Accept: 'application/json'
          }
        });

        if (!res.ok) return null;

        const results = await res.json();
        if (!results.length) return null;

        const lat = Number(results[0].lat);
        const lng = Number(results[0].lon);

        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }

      /* --- Constants --- */
      const GOOGLE_FORM_BASE =
        'https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true';
      const POLICE_NUMBER = '100';

      const KEYS = {
        name: 'sjw-user-name',
        age: 'sjw-user-age',
        emergency: 'sjw-user-emergency-contact'
      };

      /* --- Translations --- */
      const translations = {
        en: {
          title: 'South JLM Watch',
          meta: 'A simple community safety reporting demo (south Jerusalem)',
          offline:
            'âš ï¸ Offline mode: Reporting and map viewing require an internet connection.',
          callPolice: 'Police ðŸ“ž',
          toggle: '×¢×‘×¨×™×ª ðŸ‡®ðŸ‡±',
          userHeading: 'Your info',
          hint: 'Saved locally on this device',
          emergencyContact: 'Emergency Contact',
          name: 'Name',
          age: 'Age',
          location: 'Location',
          date: 'Date',
          time: 'Time',
          save: 'Save',
          clear: 'Clear',
          select: 'Select incident type(s)',
          selected: 'Selected',
          description: 'Description',
          submit: 'Submit',
          submitAnother: 'Submit another report',
          prefillHint:
            'The form will be prefilled with your location, cached name & age, and the current date/time.',
          about: 'About',
          desc: 'This is a website dedicated to keeping kids safe on the streets.',
          privacy:
            'No authentication. Public data only. Do not include personal or sensitive information.',
          mapHint:
            'Click on the map to drop a pin. The location field will be set to it automatically.',
          typeModalTitle: 'Select all that apply',
          disturbingStaring: 'Disturbing staring',
          followingOnFoot: 'Following on foot',
          followingInCar: 'Following in car',
          mockingOrPointing: 'Mocking or pointing',
          whistlingOrCatcalling: 'Whistling or catcalling',
          honking: 'Honking',
          yelling: 'Yelling',
          unwantedConversationAttempt: 'Unwanted conversation attempt',
          unwantedPickupAttempt: 'Unwanted pickup attempt',
          other: 'Other (describe below)',
          done: 'Done'
        },
        he: {
          title: '×ž×©×ž×¨ ×“×¨×•× ×™×¨×•×©×œ×™×',
          meta: '×’×¨×¡×ª ×”×“×’×ž×” ×œ×“×™×•×•×— ×§×”×™×œ×ª×™ (×“×¨×•× ×™×¨×•×©×œ×™×)',
          offline: 'âš ï¸ ×œ× ×ž×—×•×‘×¨ ×œ××™× ×˜×¨× ×˜. ×”×˜×•×¤×¡ ×•×”×ž×¤×” ×œ× ×™×¢×‘×“×•.',
          callPolice: ' ×œ×ž×©×˜×¨×” ðŸ“ž',
          toggle: 'English ðŸ‡ºðŸ‡¸',
          userHeading: '×”×ž×™×“×¢ ×©×œ×š',
          hint: '× ×©×ž×¨ ×ž×§×•×ž×™×ª ×‘×ž×›×©×™×¨ ×–×”',
          emergencyContact: '××™×© ×§×©×¨ ×—×™×¨×•×',
          name: '×©×',
          age: '×’×™×œ',
          location: '×ž×™×§×•×',
          date: '×ª××¨×™×š',
          time: '×–×ž×Ÿ',
          save: '×©×ž×•×¨',
          clear: '×ž×—×§',
          select: '×‘×—×¨×• ×ž×ª×•×š ×”××•×¤×¦×™×•×ª ×”×‘××•×ª',
          selected: '× ×‘×—×¨×•',
          description: '×”×¡×‘×¨',
          submit: '×”×’×©×ª ×ª×œ×•× ×”',
          submitAnother: '×œ×”×’×™×© ×¢×•×“ ×ª×œ×•× ×”',
          prefillHint: '×”×˜×•×¤×¡ ×™×ž×•×œ× ×‘×ž×™×§×•×, ×©× ×•×’×™×œ ×•×©×¢×ª/×ª××¨×™×š ×”×“×™×•×•×—.',
          about: '××•×“×•×ª',
          desc: '×–×” ××ª×¨ ×©×ž×•×§×“×© ×œ×©×ž×™×¨×” ×¢×œ ×™×œ×“×™× ×• ×‘×¨×—×•×‘.',
          privacy:
            '×œ×œ× ××™×ž×•×ª. × ×ª×•× ×™× ×’×œ×•×™×™× ×œ×¦×™×‘×•×¨ ×‘×œ×‘×“. ××œ ×ª×›×œ×œ×• ×ž×™×“×¢ ××™×©×™ ××• ×¨×’×™×©.',
          mapHint: '×œ×—×™×¦×” ×¢×œ ×”×ž×¤×” ×™×¢×“×›×Ÿ ××ª ×©×“×” ×”×ž×™×§×•× ×‘×˜×•×¤×¡ ×œ×ž×¢×œ×”',
          typeModalTitle: '×‘×—×¨/×™ ××ª ×›×œ ×”××¤×©×¨×•×™×•×ª ×”×ž×ª××™×ž×•×ª',
          disturbingStaring: '×‘×”×™×™×” ×ž×˜×¨×™×“×”',
          followingOnFoot: '×ž×¢×§×‘ ×¨×’×œ×™',
          followingInCar: '×ž×¢×§×‘ ×‘×¨×›×‘',
          mockingOrPointing: '×œ×¢×’ ××• ×”×¦×‘×¢×”',
          whistlingOrCatcalling: '×©×¨×™×§×•×ª ××• ×§×¨×™××•×ª',
          honking: '×¦×¤×™×¨×”',
          yelling: '×¦×¢×§×•×ª',
          unwantedConversationAttempt: '× ×™×¡×™×•×Ÿ ×©×™×—×” ×œ× ×¨×¦×•×™',
          unwantedPickupAttempt: '× ×™×¡×™×•×Ÿ ×”×ª×—×œ×” ×œ× ×¨×¦×•×™',
          other: '××—×¨ (×¤×™×¨×•×˜ ×œ×ž×˜×”)',
          done: '×¡×™×™×'
        }
      };

      const placeholders = {
        en: {
          currentLocation: 'Current Location',
          currentDate: 'Current Date',
          currentTime: 'Current Time'
        },
        he: {
          currentLocation: '×ž×™×§×•× × ×•×›×—×™',
          currentDate: '×ª××¨×™×š ×¢×“×›× ×™',
          currentTime: '×–×ž×Ÿ × ×•×›×—×™'
        }
      };

      /* --- Status --- */
      function showStatus(text, ms = 3000) {
        if (!els.status) return;
        els.status.textContent = text;
        clearTimeout(showStatus._t);
        if (ms > 0)
          showStatus._t = setTimeout(() => (els.status.textContent = ''), ms);
      }

      /* --- Language --- */
      let currentLang = localStorage.getItem('sjw-lang') || 'he';
      function updateText(lang) {
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.dataset.i18n;
          if (translations[lang] && translations[lang][key])
            el.textContent = translations[lang][key];
        });
        document.querySelectorAll('[data-i18nplaceholder]').forEach(el => {
          const key = el.dataset.i18nplaceholder;
          if (placeholders[lang] && placeholders[lang][key])
            el.placeholder = placeholders[lang][key];
        });

        updateButtonText();
      }

      function applyLang(lang) {
        currentLang = lang;
        els.html.lang = lang;
        els.html.dir = lang === 'he' ? 'rtl' : 'ltr';
        localStorage.setItem('sjw-lang', lang);
        updateText(lang);
        els.langToggle.setAttribute('aria-pressed', lang === 'he');
      }

      els.langToggle.addEventListener('click', () =>
        applyLang(currentLang === 'en' ? 'he' : 'en')
      );
      els.langToggle.addEventListener('keydown', e => {
        if (['Enter', ' '].includes(e.key)) {
          e.preventDefault();
          e.target.click();
        }
      });

      /* --- User cache --- */
      function loadUser() {
        els.name.value = localStorage.getItem(KEYS.name) || '';
        els.age.value = localStorage.getItem(KEYS.age) || '';
        els.emergency.value = localStorage.getItem(KEYS.emergency) || '';
      }

      function saveName() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || '';

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.name, val)
          : localStorage.removeItem(KEYS.name);

        showStatus(currentLang === 'en' ? 'Name saved' : '×”×©× × ×©×ž×¨', 2000);
        updateNameState();
      }

      function clearName() {
        if (localStorage.getItem(KEYS.name) === null) return;

        localStorage.removeItem(KEYS.name);
        els.name.value = '';

        showStatus(currentLang === 'en' ? 'Name cleared' : '×”×©× × ×ž×—×§', 2000);
        updateNameState();
      }

      function saveAge() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || '';

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.age, val)
          : localStorage.removeItem(KEYS.age);

        showStatus(currentLang === 'en' ? 'Age saved' : '×’×™×œ × ×©×ž×¨', 2000);
        updateAgeState();
      }

      function clearAge() {
        if (localStorage.getItem(KEYS.age) === null) return;

        localStorage.removeItem(KEYS.age);
        els.age.value = '';

        showStatus(currentLang === 'en' ? 'Age cleared' : '×’×™×œ × ×ž×—×§', 2000);
        updateAgeState();
      }

      function updateNameState() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || '';

        els.saveName.disabled = val === stored;
        els.clearName.disabled = stored === '';
      }

      function updateAgeState() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || '';

        els.saveAge.disabled = val === stored;
        els.clearAge.disabled = stored === '';
      }

      els.saveName.addEventListener('click', saveName);
      els.clearName.addEventListener('click', clearName);

      els.saveAge.addEventListener('click', saveAge);
      els.clearAge.addEventListener('click', clearAge);

      els.name.addEventListener('input', updateNameState);
      els.age.addEventListener('input', updateAgeState);

      function saveEmergency() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || '';

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.emergency, val)
          : localStorage.removeItem(KEYS.emergency);

        showStatus(
          currentLang === 'en'
            ? 'Emergency contact saved'
            : '××™×© ×§×©×¨ ×—×™×¨×•× × ×©×ž×¨',
          2000
        );
        updateEmergencyState();
      }

      function clearEmergency() {
        if (localStorage.getItem(KEYS.emergency) === null) return;

        localStorage.removeItem(KEYS.emergency);
        els.emergency.value = '';

        showStatus(
          currentLang === 'en'
            ? 'Emergency contact cleared'
            : '××™×© ×§×©×¨ ×—×™×¨×•× × ×ž×—×§',
          2000
        );
        updateEmergencyState();
      }

      function updateEmergencyState() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || '';

        els.saveEmergency.disabled = val === stored;
        els.clearEmergency.disabled = stored === '';
        els.buttons.emergency.disabled = !stored;
      }

      els.saveEmergency.addEventListener('click', saveEmergency);
      els.clearEmergency.addEventListener('click', clearEmergency);
      els.emergency.addEventListener('input', updateEmergencyState);

      /* --- Call buttons --- */
      els.buttons.police.addEventListener(
        'click',
        () => (window.location.href = `tel:${POLICE_NUMBER}`)
      );

      els.buttons.emergency.addEventListener('click', () => {
        const number = localStorage.getItem(KEYS.emergency);
        window.location.href = `tel:${number}`;
      });

      // /* --- Offline Detection --- */
      function updateOnlineStatus() {
        els.main.classList.toggle('offline', !navigator.onLine);
        els.offlineBanner.hidden = navigator.onLine;
        els.submitButton.disabled = !navigator.onLine;
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      /* --- Input Type Hack --- */
      els.formDate.addEventListener('click', () => {
        if (els.formDate.type !== 'date') els.formDate.type = 'date';
      });

      els.formTime.addEventListener('click', () => {
        if (els.formTime.type !== 'time') els.formTime.type = 'time';
      });

      /* --- Modal --- */

      let lastFocusedElement = null;

      els.openBtn.addEventListener('click', () => {
        lastFocusedElement = document.activeElement;
        els.modal.showModal();
      });

      els.modal.addEventListener('close', () => {
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
        updateButtonText();
      });

      els.modal.addEventListener('click', e => {
        if (e.target === els.modal) {
          els.modal.close();
        }
      });

      els.closeBtn.addEventListener('click', () => {
        els.modal.close();
      });

      function updateButtonText() {
        const checked = document.querySelectorAll(
          'input[name="entry.373709611"]:checked'
        );

        if (checked.length === 0) {
          els.openBtn.textContent = translations[currentLang].select;
        } else if (checked.length === 1) {
          els.openBtn.textContent = checked[0].nextElementSibling.textContent;
        } else {
          els.openBtn.textContent =
            translations[currentLang].selected + ' ' + checked.length;
        }
      }

      /* --- Submit Form --- */

      // Helper to get geolocation as a promise
      const getLocation = () =>
        new Promise(resolve => {
          if (!navigator.geolocation) return resolve('unknown');

          navigator.geolocation.getCurrentPosition(
            pos => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`),
            err => {
              console.warn('Geolocation error:', err);
              resolve('unknown');
            },
            {
              enableHighAccuracy: true, // try for more precise location
              timeout: 5000, // wait up to 5 seconds
              maximumAge: 0 // don't use cached location
            }
          );
        });

      function finalizeSubmit() {
        els.form.submit();
        els.formSection.style.display = 'none';
        els.successMessage.hidden = false;
        els.anotherReport.hidden = false;
      }

      els.form.addEventListener('submit', async e => {
        e.preventDefault();

        const now = new Date();

        // Fill date and time if empty
        els.formDate.value ||= now.toISOString().split('T')[0];
        els.formTime.value ||= now.toTimeString().slice(0, 5);

        // Fill location or convert text â†’ coordinates
        if (!els.location.value) {
          els.location.value = await getLocation();
        } else if (!looksLikeCoordinates(els.location.value)) {
          const coords = await geocodeLocationText(els.location.value);
          if (!coords) {
            alert('Could not resolve location. Please be more specific.');
            return;
          }
          els.location.value = coords;
        }

        finalizeSubmit();
      });

      function resetIncidentTypes() {
        const checkboxes = document.querySelectorAll(
          'input[name="entry.373709611"]'
        );

        checkboxes.forEach(cb => {
          cb.checked = false;
        });

        updateButtonText();
      }

      els.anotherReport.addEventListener('click', () => {
        els.formSection.style.display = 'block';
        els.successMessage.hidden = true;
        els.anotherReport.hidden = true;
        els.location.value = '';
        els.formDate.value = '';
        els.formDate.type = 'text';
        els.formTime.value = '';
        els.formTime.type = 'text';
        els.formDesc.value = '';

        resumed = false;
      });

      /* --- Init --- */
      loadUser();
      updateNameState();
      updateAgeState();
      updateEmergencyState();
      updateOnlineStatus();
      applyLang(currentLang);

      /* --- Service Worker --- */
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/jwatch/sw.js', { scope: '/jwatch/' })
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.warn('SW register failed:', err));
        });
      }
    </script>
  </body>
</html>
