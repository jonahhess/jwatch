<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="South Jerusalem Watch" />
    <title>South Jerusalem Watch</title>

    <!-- Manifest for PWA (keep if you already placed /manifest.json) -->
    <link rel="manifest" href="/manifest.json" />

    <style>
      :root {
        --bg: #f5f5f5;
        --card: #fff;
        --accent: #0f172a;
        --muted: #666;
        --radius: 12px;
        --maxw: 900px;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background: var(--bg);
        color: #111;
      }
      .container {
        max-width: var(--maxw);
        margin: 0 auto;
        padding: 1rem;
      }
      header {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
      }
      h1 {
        margin: 0.25rem 0;
        font-size: 1.35rem;
      }
      .controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      button {
        border: 0;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        background: var(--accent);
        color: white;
        font-weight: 600;
      }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1rem;
        margin: 1rem 0;
        border: 1px solid #e6e6e6;
      }
      .iframe-wrap {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        border-radius: var(--radius);
        overflow: hidden;
      }
      iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
      }
      @media (max-width: 600px) {
        .iframe-wrap {
          padding-top: 66.66%;
        }
      }
      .meta {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .muted {
        color: var(--muted);
        font-size: 0.95rem;
        margin-top: 0.5rem;
      }
      html[dir="rtl"] .container {
        text-align: right;
      }
      html[dir="rtl"] header {
        flex-direction: row-reverse;
      }
      button:focus,
      a:focus {
        outline: 3px solid #b3c7ff;
        outline-offset: 2px;
      }
      .inline-inputs {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .inline-inputs input {
        padding: 0.4rem 0.6rem;
        border-radius: 8px;
        border: 1px solid #ddd;
      }
      #status {
        min-width: 200px;
        margin-left: 0.5rem;
        color: #444;
        font-weight: 600;
      }
      small.hint {
        display: block;
        color: var(--muted);
        margin-top: 0.35rem;
      }
      #quick-report {
        background-color: firebrick;
      }
      .call-button {
        background-color: royalblue;
      }
    </style>
  </head>

  <body>
    <main class="container" id="main">
      <header>
        <div>
          <h1 data-i18n="title">South Jerusalem Watch</h1>
          <div class="meta" data-i18n="meta">
            A simple community safety reporting demo (south Jerusalem)
          </div>
        </div>

        <div class="controls">
          <div style="display: flex; align-items: center">
            <button
              id="quick-report"
              aria-describedby="quick-desc"
              title="Quick report from your current location"
              data-i18n="quickReport"
            >
              Quick report here
            </button>
            <div id="status" role="status" aria-live="polite"></div>
          </div>

          <!-- Call Police -->
          <button
            id="call-police"
            class="call-button"
            aria-pressed="false"
            title="Call Police"
            data-i18n="callPolice"
          >
            Call Police
          </button>

          <!-- Call Emergency Contact-->
          <button
            id="call-emergency-contact"
            class="call-button"
            aria-pressed="false"
            title="Call Emergency Contact"
            data-i18n="callEmergencyContact"
          >
            Emergency Contact
          </button>

          <button id="lang-toggle" aria-pressed="false" title="Toggle language">
            עברית / English
          </button>
        </div>
      </header>

      <div id="quick-desc" class="muted card">
        <strong data-i18n="qrTitle">Quick report</strong>
        <div data-i18n="qrText">
          Use your phone to quickly send a short report with your location. The
          form will be prefilled inside the app.
        </div>
      </div>

      <!-- User cached inputs (Name, Age) -->
      <section class="card" aria-labelledby="user-heading">
        <h2 id="user-heading" data-i18n="userHeading">Your info (cached)</h2>
        <small class="hint" data-i18n="hint"
          >Saved locally on this device</small
        >

        <div class="inline-inputs" style="margin-top: 0.5rem">
          <label>
            <div style="font-weight: 600">Name</div>
            <input
              id="user-name"
              type="text"
              placeholder="Optional name (or nickname)"
              autocomplete="name"
            />
          </label>

          <label>
            <div style="font-weight: 600">Age</div>
            <input
              id="user-age"
              type="number"
              min="0"
              max="120"
              placeholder="e.g. 12"
              inputmode="numeric"
            />
          </label>

          <label>
            <div style="font-weight: 600">Emergency Contact</div>
            <input
              id="user-emergency-contact"
              type="phone"
              placeholder="enter valid phone number"
              inputmode="numeric"
            />
          </label>

          <button
            id="save-user"
            style="
              background: #fff;
              color: var(--accent);
              border: 1px solid #ddd;
              font-weight: 600;
            "
          >
            Save
          </button>
          <button
            id="clear-user"
            class="secondary"
            style="
              background: #fff;
              color: var(--accent);
              border: 1px solid #ddd;
            "
          >
            Clear
          </button>
        </div>
      </section>

      <!-- Embedded Google Form (will be replaced in-place with prefilled URL) -->
      <section class="card" aria-labelledby="form-heading">
        <h2 id="form-heading" data-i18n="formHeading">Report an incident</h2>

        <div class="iframe-wrap" title="Incident report form">
          <iframe
            id="form-frame"
            loading="lazy"
            src="https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true"
            title="Report an incident (Google Form)"
            aria-label="Report an incident form"
          ></iframe>
        </div>

        <p class="muted" style="margin-top: 0.75rem" data-i18n="prefillHint">
          The form will be prefilled with your location, cached name & age, and
          the current date/time.
        </p>
      </section>

      <!-- Embedded My Maps -->
      <section class="card" aria-labelledby="map-heading">
        <h2 id="map-heading" data-i18n="mapHeading">Explore the map</h2>

        <div class="iframe-wrap">
          <iframe
            id="map-frame"
            loading="lazy"
            src="https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=en&noprof=1"
            title="Incident map"
            aria-label="Incident map"
          ></iframe>
        </div>

        <p class="muted" style="margin-top: 0.75rem" data-i18n="mapHint">
          Tip: tap the map title to open My Maps in a new tab for full
          interaction.
        </p>
      </section>

      <section id="about-section" class="card" aria-labelledby="about-heading">
        <h2 id="about-heading" data-i18n="about">About</h2>
        <p data-i18n="desc">
          This is a website dedicated to keeping kids safe on the streets.
        </p>

        <p class="muted" data-i18n="privacy">
          No authentication. Public data only. Do not include personal or
          sensitive information.
        </p>
      </section>

      <noscript class="card">
        <strong
          >JavaScript required for quick reporting and language toggle.</strong
        >
        <div>
          If JavaScript is disabled you can still use the embedded Google Form
          and map, but quick location-based reporting won't work.
        </div>
      </noscript>
    </main>

    <script>
      const GOOGLE_FORM_BASE =
        "https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true";

      const entries = {
        en: {
          name: "entry.1563137864",
          age: "entry.552093736",
          location: "entry.1771840150",
          date: "entry.123356142",
          time: "entry.407216857",
        },
        he: {
          name: "entry.1351340282",
          age: "entry.1932330829",
          location: "entry.477369262",
          date: "entry.411715491",
          time: "entry.462606047",
        },
      };

      const formUrls = {
        en: "https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true",
        he: "https://docs.google.com/forms/d/e/1FAIpQLSe5tQtDXNzq-4zxHuJaeFwXiPQx4y3krkY90cXyXVDLACMryA/viewform?embedded=true",
      };

      const mapUrls = {
        en: "https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=en&noprof=1",
        he: "https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=he&noprof=1",
      };

      /* Translations (keeps previous behavior) */
      const translations = {
        en: {
          title: "South Jerusalem Watch",
          meta: "A simple community safety reporting demo (south Jerusalem)",
          quickReport: "Quick report here",
          callPolice: "Call Police",
          callEmergencyContact: "Emergency Contact",
          toggle: "עברית / English",
          formHeading: "Report an incident",
          mapHeading: "Explore the map",
          about: "About",
          desc: "This is a website dedicated to keeping kids safe on the streets.",
          privacy:
            "No authentication. Public data only. Do not include personal or sensitive information.",
          qrTitle: "Quick report",
          qrText:
            "Use your phone to quickly send a short report with your location. The form will be prefilled inside the app.",
          mapHint:
            "Tip: tap the map title to open My Maps in a new tab for full interaction.",
          quickBtn: "Quick report here",
          userHeading: "Your info (cached)",
          hint: "Saved locally on this device",
          prefillHint:
            "The form will be prefilled with your location, cached name & age, and the current date/time.",
        },
        he: {
          title: "משמר דרום ירושלים",
          meta: "גרסת הדגמה לדיווח קהילתי (דרום ירושלים)",
          quickReport: "דיווח מהיר",
          callPolice: "להתקשר למשטרה",
          callEmergencyContact: "להתקשר לאיש קשר חירום",
          toggle: "English / עברית",
          formHeading: "דווח על תקרית",
          mapHeading: "מפה",
          about: "אודות",
          desc: "זה אתר שמוקדש לשמירה על ילדינו ברחוב.",
          privacy:
            "ללא אימות. נתונים גלויים לציבור בלבד. אל תכללו מידע אישי או רגיש.",
          qrTitle: "דיווח מהיר",
          qrText:
            "השתמשו בטלפון כדי לשלוח דיווח קצר עם המיקום שלכם. הטופס ימולא מראש בתוך האפליקציה.",
          mapHint:
            "טיפ: הקישו על כותרת המפה כדי לפתוח את My Maps בכרטיסייה חדשה.",
          quickBtn: "דווח מהנייד",
          userHeading: "המידע שלך (נשמר במכשיר)",
          hint: "נשמר מקומית במכשיר זה",
          prefillHint: "הטופס ימולא במיקום, שם וגיל ושעת/תאריך הדיווח.",
        },
      };

      /* --- Utility functions --- */
      const htmlEl = document.documentElement;
      let currentLang = localStorage.getItem("sjw-lang") || "en";

      function updateText(lang) {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (translations[lang] && translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });
        const formFrame = document.getElementById("form-frame");
        if (formFrame) formFrame.src = formUrls[lang] || formUrls.en;
        const mapFrame = document.getElementById("map-frame");
        if (mapFrame) mapFrame.src = mapUrls[lang] || mapUrls.en;
      }

      function applyLang(lang) {
        currentLang = lang;
        htmlEl.setAttribute("dir", lang === "he" ? "rtl" : "ltr");
        htmlEl.setAttribute("lang", lang === "he" ? "he" : "en");
        localStorage.setItem("sjw-lang", lang);
        updateText(lang);
        const toggle = document.getElementById("lang-toggle");
        toggle.setAttribute("aria-pressed", lang === "he" ? "true" : "false");
      }

      applyLang(currentLang);

      document.getElementById("lang-toggle").addEventListener("click", () => {
        applyLang(currentLang === "en" ? "he" : "en");
      });

      // Inline status (aria-live) helper
      const statusEl = document.getElementById("status");
      function showStatus(text, ms = 3000) {
        if (!statusEl) return;
        statusEl.textContent = text;
        clearTimeout(statusEl._timeout);
        if (ms > 0) {
          statusEl._timeout = setTimeout(() => (statusEl.textContent = ""), ms);
        }
      }

      /* --- User caching (Name, Age, Emergency Contact) --- */
      const NAME_KEY = "sjw-user-name";
      const AGE_KEY = "sjw-user-age";
      const EMERGENCY_CONTACT_KEY = "sjw-user-emergency-contact";

      const nameInput = document.getElementById("user-name");
      const ageInput = document.getElementById("user-age");
      const emergencyContactInput = document.getElementById(
        "user-emergency-contact"
      );
      const saveBtn = document.getElementById("save-user");
      const clearBtn = document.getElementById("clear-user");

      function loadUserCache() {
        const name = localStorage.getItem(NAME_KEY) || "";
        const age = localStorage.getItem(AGE_KEY) || "";
        const emergencyContact =
          localStorage.getItem(EMERGENCY_CONTACT_KEY) || "";
        nameInput.value = name;
        ageInput.value = age;
        emergencyContactInput.value = emergencyContact;
      }

      function saveUserCache() {
        const name = nameInput.value.trim();
        const age = ageInput.value.trim();
        const emergencyContact = emergencyContactInput.value.trim();
        if (name) localStorage.setItem(NAME_KEY, name);
        else localStorage.removeItem(NAME_KEY);
        if (age) localStorage.setItem(AGE_KEY, age);
        else localStorage.removeItem(AGE_KEY);
        if (emergencyContact)
          localStorage.setItem(EMERGENCY_CONTACT_KEY, emergencyContact);
        else localStorage.removeItem(EMERGENCY_CONTACT_KEY);
        showStatus(currentLang === "he" ? "המידע נשמר" : "Info saved", 2000);
      }

      function clearUserCache() {
        localStorage.removeItem(NAME_KEY);
        localStorage.removeItem(AGE_KEY);
        localStorage.removeItem(EMERGENCY_CONTACT_KEY);
        nameInput.value = "";
        ageInput.value = "";
        emergencyContactInput.value = "";
        showStatus(currentLang === "he" ? "המידע נמחק" : "Info cleared", 2000);
      }

      saveBtn.addEventListener("click", saveUserCache);
      clearBtn.addEventListener("click", clearUserCache);
      loadUserCache();

      /*Calling Functionality */
      const callPoliceBtn = document.getElementById("call-police");
      const callEmergencyContactBtn = document.getElementById(
        "call-emergency-contact"
      );

      // Police number (hardcoded for Israel: 100)
      const POLICE_NUMBER = "100";

      callPoliceBtn.addEventListener("click", () => {
        window.location.href = `tel:${POLICE_NUMBER}`;
      });

      callEmergencyContactBtn.addEventListener("click", () => {
        const emergencyContact = localStorage.getItem(EMERGENCY_CONTACT_KEY);
        if (!emergencyContact || emergencyContact.trim() === "") {
          showStatus(
            currentLang === "he"
              ? "איש קשר חירום לא זוהה"
              : "No emergency contact available",
            3000
          );
          return;
        }
        window.location.href = `tel:${emergencyContact}`;
      });

      /* --- Prefill build helpers --- */
      function formatDateISO(d) {
        // YYYY-MM-DD
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function formatTimeHHMM(d) {
        // HH:MM (24h)
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function buildPrefillUrl(prefillParams) {
        // Build URL like: <BASE>?usp=pp_url&entry.x=...&entry.y=...&embedded=true
        const usp = "usp=pp_url";
        const params = new URLSearchParams(prefillParams);
        const url = `${
          formUrls[currentLang] || GOOGLE_FORM_BASE
        }?${usp}&${params.toString()}`;
        return url;
      }

      async function getLocation(prefill) {
        const opts = {
          enableHighAccuracy: true,
          maximumAge: 30_000,
          timeout: 8000,
        };

        if (!navigator.geolocation) {
          return "";
        }

        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, opts);
          });

          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          return `${lat},${lon}`; // format compatible with My Maps
        } catch (err) {
          // permission denied, timeout, etc.
          return "";
        }
      }

      /* --- Quick-report flow (prefills single Location field + user & date/time) --- */
      const quickBtn = document.getElementById("quick-report");
      const formFrame = document.getElementById("form-frame");

      quickBtn.addEventListener("click", async () => {
        // read cached user info
        const cachedName = localStorage.getItem(NAME_KEY) || "";
        const cachedAge = localStorage.getItem(AGE_KEY) || "";

        // Prepare date & time now (when the user initiates the report)
        const now = new Date();
        const dateStr = formatDateISO(now);
        const timeStr = formatTimeHHMM(now);

        const prefill = {};
        if (cachedName) prefill[entries[currentLang].name] = cachedName;
        if (cachedAge) prefill[entries[currentLang].age] = cachedAge;
        prefill[entries[currentLang].date] = dateStr;
        prefill[entries[currentLang].time] = timeStr;

        const location = await getLocation();
        console.log(location);
        if (location) prefill[entries[currentLang].location] = location;

        const prefilledUrl = buildPrefillUrl(prefill);
        formFrame.src = prefilledUrl;
      });

      // accessibility helpers
      document
        .getElementById("lang-toggle")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            e.target.click();
          }
        });

      // Register service worker for PWA (if /sw.js exists)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/sw.js")
            .then((reg) => console.log("SW registered:", reg.scope))
            .catch((err) => console.warn("SW register failed:", err));
        });
      }
    </script>
  </body>
</html>
