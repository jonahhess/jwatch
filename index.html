<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="South Jerusalem Watch" />
    <meta name="theme-color" content="#0f172a" />

    <!-- iOS PWA -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SJ Watch" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png" />

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" href="/favicon-16x16.png" type="image/png" />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Manifest -->
    <link rel="canonical" href="https://jonahhess.github.io/jwatch/" />
    <link
      rel="manifest"
      href="https://jonahhess.github.io/jwatch/manifest.json"
    />

    <title>South Jerusalem Watch</title>

    <style>
      :root {
        /* Spacing scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 1rem;
        --space-4: 1.5rem;
        --space-5: 2rem;

        --space: 0.75rem;

        /* Typography */
        --font-base: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;

        --text-base: 1rem;
        --text-small: 0.875rem;
        --text-large: 1.25rem;

        --text-bold: 600;

        /* Colors */
        --color-bg: #f7f7f7;
        --color-surface: #ffffff;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-accent: #0a66c2;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        font-family: var(--font-base);
        font-size: 100%;
        line-height: 1.5;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
        max-width: 900px;
        margin: auto;
      }

      #title-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
        column-gap: var(--space);
        align-items: center;
      }

      /* Logo: align with title row only */
      #logo-container {
        grid-column: 1;
        grid-row: 1;
        margin-top: var(--space);
      }

      #logo-container img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        display: block;
      }

      /* Title */
      #title {
        grid-column: 2;
        grid-row: 1;

        margin: 0;
        font-size: var(--text-large);
        line-height: 1.2;
      }

      #meta {
        grid-column: 2;
        grid-row: 2;
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      section {
        margin: var(--space-2);
      }

      main {
        padding-left: var(--space-3);
        padding-right: var(--space-3);
      }

      #offline-banner {
        background-color: #fffbcc;
        color: var(--color-muted);
        padding: var(--space-2) var(--space-3);
        text-align: center;
        font-size: var(--text-small);
        border-bottom: 1px solid #f0e68c;
        position: sticky;
        top: 0;
        z-index: 1001;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        position: relative;
        z-index: 0;
        overflow: visible;
      }

      button {
        font: inherit;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      #status {
        min-height: var(--space-4);
        margin-top: var(--space-2);
      }

      .card {
        background: var(--color-surface);
        border-radius: var(--space);
        padding: var(--space-3);
        border: 1px solid var(--color-border);
      }

      #hint {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      label {
        font-size: var(--text-small);
      }

      input {
        font: inherit;
        padding: var(--space-2);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
      }

      html[dir="rtl"] {
        direction: rtl;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: var(--space-3);
      }

      .form-row {
        width: 100%;
      }

      label span {
        display: block;
        font-weight: var(--text-bold);
        margin-bottom: var(--space-1);
      }

      input,
      textarea,
      select,
      button {
        width: 100%;
        font-size: var(--text-base);
      }

      @supports (-webkit-touch-callout: none) {
        *,
        *::before,
        *::after {
          -webkit-tap-highlight-color: transparent;
        }
        body {
          -webkit-text-size-adjust: 100%;
        }
        button {
          -webkit-tap-highlight-color: initial;
        }
        input[type="date"],
        input[type="time"] {
          width: calc(100% - 16px);
        }
      }

      textarea {
        border-color: lightgrey;
        border-radius: var(--space-2);
      }

      .inline-controls {
        display: flex;
        gap: var(--space-2);
      }

      select[multiple] {
        min-height: 8rem;
      }

      #open-type-picker,
      #close-type-picker,
      .option-list {
        padding: var(--space);
        font-size: var(--text-base);
      }

      #open-type-picker {
        color: var(--color-text);
        width: var(100% - 16px);
      }

      #close-type-picker {
        width: 100%;
      }

      dialog:not([open]) {
        display: none;
      }

      dialog {
        border: none;
        padding: var(--space-3);
        border-radius: 12px;

        width: min(90vw, 480px);
        max-height: 80vh;

        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.4);
      }

      .option-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .option-list li {
        margin-bottom: var(--space-2);
      }

      .option-list label {
        display: flex;
        align-items: center;
        gap: var(--space);

        padding: var(--space) var(--space-3);
        border-radius: 8px;
        cursor: pointer;

        border: 1px solid #ddd;

        transition: background 0.2s, border-color 0.2s;
      }

      .option-list input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .option-list label:hover {
        background: #f5f7fa;
      }

      .option-list input:checked + span {
        font-weight: var(--text-bold);
      }

      .option-list input:checked + span::before {
        content: "‚úì";
        display: inline-block;
        margin-inline-end: var(--space-2);
      }

      .option-list input:focus-visible + span {
        outline: 2px so;
      }

      /* CSS: flexible, responsive container */
      .map-section {
        width: 100%; /* full width of parent */
        height: 50vh; /* 50% of viewport height, adjust as needed */
        min-height: 300px; /* don't get too small */
        border: 1px solid #ccc;
      }

      /* Base READ mode ‚Äî normal map in page flow */
      #map {
        display: block; /* ensure block-level element */
        width: 100%; /* fill parent container */
        height: 400px; /* explicit height so Leaflet renders tiles */
        margin-bottom: var(--space);
        border-radius: 6px;
        border: 1px solid #ccc;

        /* reset transform/position in read mode */
        position: static;
        top: auto;
        left: auto;
        transform: none;
      }

      /* WRITE mode ‚Äî centered popover */
      #map:popover-open {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        width: min(90vw, 600px);
        height: min(70vh, 450px);

        border-radius: 12px;
        z-index: 9999;
        opacity: 0;
      }

      /* Animate to fully visible after paint */
      #map:popover-open.open {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      #submit {
        color: var(--color-text);
      }
    </style>
  </head>

  <body>
    <main>
      <div id="offline-banner" hidden data-i18n="offline"></div>

      <header>
        <div id="title-meta">
          <div id="logo-container">
            <img src="favicon.ico" alt="South Jerusalem Watch Logo" />
          </div>
          <h1 id="title" data-i18n="title"></h1>
          <div id="meta" data-i18n="meta"></div>
        </div>

        <div id="status" role="status" aria-live="polite"></div>

        <!-- Button Section -->
        <section class="card inline-controls">
          <button
            id="call-police"
            aria-pressed="false"
            aria-label="Call Police"
            data-i18n="callPolice"
          ></button>
          <button
            id="lang-toggle"
            aria-pressed="false"
            aria-label="Toggle language"
            data-i18n="toggle"
          ></button>
        </section>
      </header>

      <!-- Emergency Contact Section -->
      <section class="card">
        <label>
          <span data-i18n="emergencyContact"></span>
          <div class="inline-controls">
            <input
              id="user-emergency-contact"
              type="tel"
              pattern="/d{3}-/d{3}-/d{4}"
            />
            <button id="save-emergency" type="button" data-i18n="save"></button>
            <button
              id="clear-emergency"
              type="button"
              data-i18n="clear"
            ></button>
            <button
              id="call-emergency-contact"
              aria-pressed="false"
              aria-label="Call Emergency Contact"
            >
              üìû
            </button>
          </div>
        </label>
      </section>

      <!--- Form entries-->
      <section class="card" id="form-section">
        <form
          id="form"
          action="https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/formResponse"
          method="POST"
          target="hidden_iframe"
        >
          <div class="form-grid">
            <!-- Name -->
            <div class="form-row">
              <label>
                <span data-i18n="name"></span>
                <div class="inline-controls">
                  <input
                    id="user-name"
                    type="text"
                    name="entry.1563137864"
                    autocomplete="name"
                  />
                  <button
                    id="save-name"
                    type="button"
                    data-i18n="save"
                  ></button>
                  <button
                    id="clear-name"
                    type="button"
                    data-i18n="clear"
                  ></button>
                </div>
              </label>
            </div>

            <!-- Age -->
            <div class="form-row">
              <label>
                <span data-i18n="age"></span>
                <div class="inline-controls">
                  <input
                    id="user-age"
                    type="number"
                    name="entry.552093736"
                    min="0"
                    value="0"
                  />
                  <button id="save-age" type="button" data-i18n="save"></button>
                  <button
                    id="clear-age"
                    type="button"
                    data-i18n="clear"
                  ></button>
                </div>
              </label>
            </div>

            <!-- Location -->
            <div class="form-row">
              <label>
                <span data-i18n="location"></span>
                <div class="inline-controls">
                  <input
                    id="location"
                    type="text"
                    name="entry.1771840150"
                    data-i18nplaceholder="currentLocation"
                  />
                  <button
                    id="pick-location"
                    type="button"
                    popovertarget="map"
                    popovertargetaction="toggle"
                    style="max-width: fit-content"
                    aria-label="Pick location on map"
                  >
                    üìç
                  </button>
                </div>
              </label>
            </div>

            <!-- Date -->
            <div class="form-row">
              <label>
                <span data-i18n="date"></span>
                <input
                  id="form-date"
                  type="text"
                  onfocus="(this.type='date')"
                  onblur="(this.type='text')"
                  name="entry.123356142"
                  data-i18nplaceholder="currentDate"
                />
              </label>
            </div>

            <!-- Time -->
            <div class="form-row">
              <label>
                <span data-i18n="time"></span>
                <input
                  id="form-time"
                  type="text"
                  onfocus="(this.type='time')"
                  onblur="(this.type='text')"
                  name="entry.407216857"
                  data-i18nplaceholder="currentTime"
                />
              </label>
            </div>

            <!-- Type (Dropdown) -->
            <div class="form-row">
              <label>
                <span data-i18n="type"></span>
                <button
                  type="button"
                  id="open-type-picker"
                  data-i18n="select"
                ></button>
              </label>

              <!-- Hidden container for generated inputs -->
              <input id="type-hidden-inputs" name="entry.373709611" hidden />
            </div>

            <!-- Description -->
            <div class="form-row">
              <label>
                <span data-i18n="description"></span>
                <textarea id="form-desc" name="entry.737097719"></textarea>
              </label>
            </div>

            <!-- Submit -->
            <div class="form-row">
              <button id="submit" type="submit" data-i18n="submit"></button>
            </div>
          </div>
        </form>

        <div id="form-success" hidden data-i18n="success"></div>

        <iframe
          name="hidden_iframe"
          id="hidden_iframe"
          style="display: none"
        ></iframe>
        <button id="another-report" data-i18n="submitAnother" hidden></button>
      </section>

      <!-- Map section -->
      <section class="card" id="map-section">
        <div id="map" popover="auto"></div>
        <div id="hint" data-i18n="mapHint"></div>
      </section>

      <!-- About Section -->
      <section class="card">
        <h2 data-i18n="about"></h2>
        <p data-i18n="desc"></p>
      </section>

      <noscript class="card">
        <strong>JavaScript required for reporting and language toggle.</strong>
      </noscript>

      <!-- Dialog -->
      <dialog id="type-modal">
        <div class="modal-sheet">
          <h3 data-i18n="typeModalTitle"></h3>

          <ul class="option-list">
            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Disturbing staring"
                />
                <span data-i18n="disturbingStaring"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Following on foot"
                />
                <span data-i18n="followingOnFoot"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Following in car"
                />
                <span data-i18n="followingInCar"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Mocking or pointing"
                />
                <span data-i18n="mockingOrPointing"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Whistling or catcalling"
                />
                <span data-i18n="whistlingOrCatcalling"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="Honking" />
                <span data-i18n="honking"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="Yelling" />
                <span data-i18n="yelling"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Unwanted conversation attempt"
                />
                <span data-i18n="unwantedConversationAttempt"></span>
              </label>
            </li>

            <li>
              <label>
                <input
                  type="checkbox"
                  name="entry.373709611"
                  value="Unwanted pickup attempt"
                />
                <span data-i18n="unwantedPickupAttempt"></span>
              </label>
            </li>

            <li>
              <label>
                <input type="checkbox" name="entry.373709611" value="Other" />
                <span data-i18n="other"></span>
              </label>
            </li>
          </ul>

          <button
            type="button"
            id="close-type-picker"
            data-i18n="done"
          ></button>
        </div>
      </dialog>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      /* --- DOM helpers --- */
      const $ = (id) => document.getElementById(id);

      const els = {
        html: document.documentElement,
        offlineBanner: $("offline-banner"),
        status: $("status"),
        langToggle: $("lang-toggle"),
        form: $("form"),
        location: $("location"),
        pickBtn: $("pick-location"),
        formDate: $("form-date"),
        formTime: $("form-time"),
        formDesc: $("form-desc"),
        submitButton: $("submit"),
        successMessage: $("form-success"),
        anotherReport: $("another-report"),
        mapSection: $("map-section"),
        map: $("map"),
        buttons: {
          police: $("call-police"),
          emergency: $("call-emergency-contact"),
        },
        emergency: $("user-emergency-contact"),
        saveEmergency: $("save-emergency"),
        clearEmergency: $("clear-emergency"),
        name: $("user-name"),
        age: $("user-age"),
        saveName: $("save-name"),
        clearName: $("clear-name"),
        saveAge: $("save-age"),
        clearAge: $("clear-age"),
        modal: $("type-modal"),
        openBtn: $("open-type-picker"),
        closeBtn: $("close-type-picker"),
        hiddenInputs: $("type-hidden-inputs"),
      };

      /* Map Logic */
      const MapMode = {
        READ: "read",
        WRITE: "write",
      };

      let currentMode = MapMode.READ;

      /*********************************************************
       * CONFIG
       *********************************************************/

      const MAP_CENTER = [31.758837, 35.2]; // default map center
      const MAP_ZOOM = 13;

      const SHEET_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5GK9JffVcBGw4sN4Wda3jKCIdGBibjFMsHHIc1Xsc85sJvAVXson-B7v2L5imp-PdQy623QxA8J_R/pub?output=csv";

      /*********************************************************
       * STATE
       *********************************************************/

      let mapInitialized = false;
      let map;
      let incidentLayer;
      let draftLayer;
      let draftMarker;

      /*********************************************************
       * UTILITIES
       *********************************************************/

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }

      function loadCSS(href) {
        const l = document.createElement("link");
        l.rel = "stylesheet";
        l.href = href;
        document.head.appendChild(l);
      }

      function updateLocationInput(lat, lng) {
        if (!els.location) return;
        els.location.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }

      /*********************************************************
       * MAP INITIALIZATION
       *********************************************************/

      function setReadMode() {
        currentMode = MapMode.READ;

        draftLayer.clearLayers();
        draftMarker = null;

        map.dragging.enable();
        map.scrollWheelZoom.enable();

        // Ensure Leaflet knows container is visible
        requestAnimationFrame(() => map.invalidateSize());
      }

      function setWriteMode() {
        currentMode = MapMode.WRITE;

        draftLayer.clearLayers();
        draftMarker = null;

        map.dragging.enable();
        map.scrollWheelZoom.enable();

        requestAnimationFrame(() => map.invalidateSize());
        map.on("click", onDraftClick);
      }

      function onDraftClick(e) {
        const { lat, lng } = e.latlng;

        draftLayer.clearLayers();

        draftMarker = L.marker([lat, lng], {
          draggable: true,
          opacity: 0.85,
        }).addTo(draftLayer);

        updateLocationInput(lat, lng);

        draftMarker.on("dragend", (ev) => {
          const pos = ev.target.getLatLng();
          updateLocationInput(pos.lat, pos.lng);
        });
      }

      async function initMap() {
        if (mapInitialized) return;
        mapInitialized = true;

        // Load Leaflet assets
        loadCSS("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css");
        await Promise.all([
          loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"),
          loadScript("https://unpkg.com/papaparse@5.4.1/papaparse.min.js"),
        ]);

        // Create map
        map = L.map("map").setView(MAP_CENTER, MAP_ZOOM);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // Layers
        incidentLayer = L.layerGroup().addTo(map);
        draftLayer = L.layerGroup().addTo(map);

        // Load incidents
        loadIncidents();

        setReadMode();
      }

      /*********************************************************
       * DATA LOADING (READ SIDE)
       *********************************************************/

      function normalizeRow(raw) {
        return {
          timestamp: raw["Timestamp"],
          name: raw["Your name (optional)"],
          age: raw["Age"],
          location: raw["Location of incident (address and/or coordinates) "],
          date: raw["Date of incident (YYYY-MM-DD)"],
          time: raw["Time of incident (HH:MM (24h))"],
          incident_type: raw["Type of incident "],
          description: raw["Description of incident and/or individuals"],
        };
      }

      function escapeHTML(str) {
        return String(str).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function parseCSV(csvText) {
        const result = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
        });
        return result.data;
      }

      function buildIncidentPopup(row) {
        const fields = [
          ["Type", row.incident_type],
          ["Description", row.description],
          ["Date", row.date],
          ["Time", row.time],
          ["Location", row.location],
          ["Age", row.age],
          ["Reported by", row.name],
          ["Submitted", row.timestamp],
        ];

        return `
    <div class="popup">
      <strong>${row.incident_type || "Incident"}</strong>
      <table>
        ${fields
          .map(
            ([label, value]) => `
              <tr>
                <td><strong>${label}</strong></td>
                <td>${escapeHTML(value)}</td>
              </tr>
            `
          )
          .join("")}
      </table>
    </div>
  `;
      }

      function loadIncidents() {
        if (!SHEET_URL) return;

        fetch(SHEET_URL)
          .then((res) => res.text())
          .then((csv) => {
            parseCSV(csv).forEach((row) =>
              addIncidentMarker(normalizeRow(row))
            );
          })
          .catch((err) => console.error("Incident load failed:", err));
      }

      function addIncidentMarker(row) {
        if (!row.location) return;

        const [lat, lng] = row.location.split(",").map(Number);
        if (isNaN(lat) || isNaN(lng)) return;

        const popup = buildIncidentPopup(row);

        L.marker([lat, lng]).bindPopup(popup).addTo(incidentLayer);
      }

      /*********************************************************
       * LAZY LOAD TRIGGER
       *********************************************************/

      document.addEventListener("DOMContentLoaded", () => {
        if (!els.map) return;

        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting) {
              initMap();
              observer.disconnect();
            }
          },
          { rootMargin: "200px" }
        );

        observer.observe(els.mapSection);
      });

      function looksLikeCoordinates(value) {
        return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test(value);
      }

      async function geocodeLocationText(text) {
        const url =
          "https://nominatim.openstreetmap.org/search?" +
          new URLSearchParams({
            q: text,
            format: "json",
            limit: 1,
          });

        const res = await fetch(url, {
          headers: {
            Accept: "application/json",
          },
        });

        if (!res.ok) return null;

        const results = await res.json();
        if (!results.length) return null;

        const lat = Number(results[0].lat);
        const lng = Number(results[0].lon);

        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }

      function scrollPopoverToCenter() {
        const viewportHeight = window.innerHeight;
        const popoverRect = els.map.getBoundingClientRect();
        const popoverHeight = popoverRect.height;

        // Calculate the scroll so that the popover's center is in viewport center
        const scrollTop =
          window.scrollY +
          popoverRect.top -
          (viewportHeight - popoverHeight) / 2;

        window.scrollTo({
          top: scrollTop,
          behavior: "smooth",
        });
      }

      els.map.addEventListener("beforetoggle", async (e) => {
        if (e.newState === "open") {
          await initMap();
          setWriteMode();

          // Scroll page so the button is near the top
          els.pickBtn.scrollIntoView({ behavior: "smooth", block: "center" });

          requestAnimationFrame(() => {
            map.invalidateSize();
            scrollPopoverToCenter();
            els.map.classList.add("open");
          });
        } else {
          setReadMode();
          els.map.classList.remove("open");
        }
      });

      /* --- Constants --- */
      const GOOGLE_FORM_BASE =
        "https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true";
      const POLICE_NUMBER = "100";

      const KEYS = {
        name: "sjw-user-name",
        age: "sjw-user-age",
        emergency: "sjw-user-emergency-contact",
      };

      /* --- Translations --- */
      const translations = {
        en: {
          title: "South JLM Watch",
          meta: "A simple community safety reporting demo (south Jerusalem)",
          offline:
            "‚ö†Ô∏è Offline mode: Reporting and map viewing require an internet connection.",
          callPolice: "Police üìû",
          toggle: "◊¢◊ë◊®◊ô◊™ üáÆüá±",
          userHeading: "Your info",
          hint: "Saved locally on this device",
          emergencyContact: "Emergency Contact",
          name: "Name",
          age: "Age",
          location: "Location",
          date: "Date",
          time: "Time",
          save: "Save",
          clear: "Clear",
          type: "Incident Type",
          select: "Select incident type(s)",
          selected: "Selected",
          description: "Description",
          submit: "Submit",
          submitAnother: "Submit another report",
          prefillHint:
            "The form will be prefilled with your location, cached name & age, and the current date/time.",
          about: "About",
          desc: "This is a website dedicated to keeping kids safe on the streets.",
          privacy:
            "No authentication. Public data only. Do not include personal or sensitive information.",
          mapHint:
            "Click on the map to drop a pin. The location field will be set to it automatically.",
          typeModalTitle: "Select all that apply",
          disturbingStaring: "Disturbing staring",
          followingOnFoot: "Following on foot",
          followingInCar: "Following in car",
          mockingOrPointing: "Mocking or pointing",
          whistlingOrCatcalling: "Whistling or catcalling",
          honking: "Honking",
          yelling: "Yelling",
          unwantedConversationAttempt: "Unwanted conversation attempt",
          unwantedPickupAttempt: "Unwanted pickup attempt",
          other: "Other (describe below)",
          done: "Done",
        },
        he: {
          title: "◊û◊©◊û◊® ◊ì◊®◊ï◊ù ◊ô◊®◊ï◊©◊ú◊ô◊ù",
          meta: "◊í◊®◊°◊™ ◊î◊ì◊í◊û◊î ◊ú◊ì◊ô◊ï◊ï◊ó ◊ß◊î◊ô◊ú◊™◊ô (◊ì◊®◊ï◊ù ◊ô◊®◊ï◊©◊ú◊ô◊ù)",
          offline: "‚ö†Ô∏è ◊ú◊ê ◊û◊ó◊ï◊ë◊® ◊ú◊ê◊ô◊†◊ò◊®◊†◊ò. ◊î◊ò◊ï◊§◊° ◊ï◊î◊û◊§◊î ◊ú◊ê ◊ô◊¢◊ë◊ì◊ï.",
          callPolice: " ◊ú◊û◊©◊ò◊®◊î üìû",
          toggle: "English üá∫üá∏",
          userHeading: "◊î◊û◊ô◊ì◊¢ ◊©◊ú◊ö",
          hint: "◊†◊©◊û◊® ◊û◊ß◊ï◊û◊ô◊™ ◊ë◊û◊õ◊©◊ô◊® ◊ñ◊î",
          emergencyContact: "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù",
          name: "◊©◊ù",
          age: "◊í◊ô◊ú",
          location: "◊û◊ô◊ß◊ï◊ù",
          date: "◊™◊ê◊®◊ô◊ö",
          time: "◊ñ◊û◊ü",
          save: "◊©◊û◊ï◊®",
          clear: "◊û◊ó◊ß",
          type: "◊°◊ï◊í ◊™◊ß◊®◊ô◊™",
          select: "◊ë◊ó◊®◊ï ◊û◊™◊ï◊ö ◊î◊ê◊ï◊§◊¶◊ô◊ï◊™ ◊î◊ë◊ê◊ï◊™",
          selected: "◊†◊ë◊ó◊®◊ï",
          description: "◊î◊°◊ë◊®",
          submit: "◊î◊í◊©◊™ ◊™◊ú◊ï◊†◊î",
          submitAnother: "◊ú◊î◊í◊ô◊© ◊¢◊ï◊ì ◊™◊ú◊ï◊†◊î",
          prefillHint: "◊î◊ò◊ï◊§◊° ◊ô◊û◊ï◊ú◊ê ◊ë◊û◊ô◊ß◊ï◊ù, ◊©◊ù ◊ï◊í◊ô◊ú ◊ï◊©◊¢◊™/◊™◊ê◊®◊ô◊ö ◊î◊ì◊ô◊ï◊ï◊ó.",
          about: "◊ê◊ï◊ì◊ï◊™",
          desc: "◊ñ◊î ◊ê◊™◊® ◊©◊û◊ï◊ß◊ì◊© ◊ú◊©◊û◊ô◊®◊î ◊¢◊ú ◊ô◊ú◊ì◊ô◊†◊ï ◊ë◊®◊ó◊ï◊ë.",
          privacy:
            "◊ú◊ú◊ê ◊ê◊ô◊û◊ï◊™. ◊†◊™◊ï◊†◊ô◊ù ◊í◊ú◊ï◊ô◊ô◊ù ◊ú◊¶◊ô◊ë◊ï◊® ◊ë◊ú◊ë◊ì. ◊ê◊ú ◊™◊õ◊ú◊ú◊ï ◊û◊ô◊ì◊¢ ◊ê◊ô◊©◊ô ◊ê◊ï ◊®◊í◊ô◊©.",
          mapHint: "◊ú◊ó◊ô◊¶◊î ◊¢◊ú ◊î◊û◊§◊î ◊ô◊¢◊ì◊õ◊ü ◊ê◊™ ◊©◊ì◊î ◊î◊û◊ô◊ß◊ï◊ù ◊ë◊ò◊ï◊§◊° ◊ú◊û◊¢◊ú◊î",
          typeModalTitle: "◊ë◊ó◊®/◊ô ◊ê◊™ ◊õ◊ú ◊î◊ê◊§◊©◊®◊ï◊ô◊ï◊™ ◊î◊û◊™◊ê◊ô◊û◊ï◊™",
          disturbingStaring: "◊ë◊î◊ô◊ô◊î ◊û◊ò◊®◊ô◊ì◊î",
          followingOnFoot: "◊û◊¢◊ß◊ë ◊®◊í◊ú◊ô",
          followingInCar: "◊û◊¢◊ß◊ë ◊ë◊®◊õ◊ë",
          mockingOrPointing: "◊ú◊¢◊í ◊ê◊ï ◊î◊¶◊ë◊¢◊î",
          whistlingOrCatcalling: "◊©◊®◊ô◊ß◊ï◊™ ◊ê◊ï ◊ß◊®◊ô◊ê◊ï◊™",
          honking: "◊¶◊§◊ô◊®◊î",
          yelling: "◊¶◊¢◊ß◊ï◊™",
          unwantedConversationAttempt: "◊†◊ô◊°◊ô◊ï◊ü ◊©◊ô◊ó◊î ◊ú◊ê ◊®◊¶◊ï◊ô",
          unwantedPickupAttempt: "◊†◊ô◊°◊ô◊ï◊ü ◊î◊™◊ó◊ú◊î ◊ú◊ê ◊®◊¶◊ï◊ô",
          other: "◊ê◊ó◊® (◊§◊ô◊®◊ï◊ò ◊ú◊û◊ò◊î)",
          done: "◊°◊ô◊ô◊ù",
        },
      };

      const placeholders = {
        en: {
          currentLocation: "Current Location",
          currentDate: "Current Date",
          currentTime: "Current Time",
        },
        he: {
          currentLocation: "◊û◊ô◊ß◊ï◊ù ◊†◊ï◊õ◊ó◊ô",
          currentDate: "◊™◊ê◊®◊ô◊ö ◊¢◊ì◊õ◊†◊ô",
          currentTime: "◊ñ◊û◊ü ◊†◊ï◊õ◊ó◊ô",
        },
      };

      /* --- Status --- */
      function showStatus(text, ms = 3000) {
        if (!els.status) return;
        els.status.textContent = text;
        clearTimeout(showStatus._t);
        if (ms > 0)
          showStatus._t = setTimeout(() => (els.status.textContent = ""), ms);
      }

      /* --- Language --- */
      let currentLang = localStorage.getItem("sjw-lang") || "he";
      function updateText(lang) {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.dataset.i18n;
          if (translations[lang] && translations[lang][key])
            el.textContent = translations[lang][key];
        });
        document.querySelectorAll("[data-i18nplaceholder]").forEach((el) => {
          const key = el.dataset.i18nplaceholder;
          if (placeholders[lang] && placeholders[lang][key])
            el.placeholder = placeholders[lang][key];
        });

        updateButtonText();
      }

      function applyLang(lang) {
        currentLang = lang;
        els.html.lang = lang;
        els.html.dir = lang === "he" ? "rtl" : "ltr";
        localStorage.setItem("sjw-lang", lang);
        updateText(lang);
        els.langToggle.setAttribute("aria-pressed", lang === "he");
      }

      els.langToggle.addEventListener("click", () =>
        applyLang(currentLang === "en" ? "he" : "en")
      );
      els.langToggle.addEventListener("keydown", (e) => {
        if (["Enter", " "].includes(e.key)) {
          e.preventDefault();
          e.target.click();
        }
      });

      /* --- User cache --- */
      function loadUser() {
        els.name.value = localStorage.getItem(KEYS.name) || "";
        els.age.value = localStorage.getItem(KEYS.age) || "";
        els.emergency.value = localStorage.getItem(KEYS.emergency) || "";
      }

      function saveName() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.name, val)
          : localStorage.removeItem(KEYS.name);

        showStatus(currentLang === "en" ? "Name saved" : "◊î◊©◊ù ◊†◊©◊û◊®", 2000);
        updateNameState();
      }

      function clearName() {
        if (localStorage.getItem(KEYS.name) === null) return;

        localStorage.removeItem(KEYS.name);
        els.name.value = "";

        showStatus(currentLang === "en" ? "Name cleared" : "◊î◊©◊ù ◊†◊û◊ó◊ß", 2000);
        updateNameState();
      }

      function saveAge() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.age, val)
          : localStorage.removeItem(KEYS.age);

        showStatus(currentLang === "en" ? "Age saved" : "◊í◊ô◊ú ◊†◊©◊û◊®", 2000);
        updateAgeState();
      }

      function clearAge() {
        if (localStorage.getItem(KEYS.age) === null) return;

        localStorage.removeItem(KEYS.age);
        els.age.value = "";

        showStatus(currentLang === "en" ? "Age cleared" : "◊í◊ô◊ú ◊†◊û◊ó◊ß", 2000);
        updateAgeState();
      }

      function updateNameState() {
        const val = els.name.value.trim();
        const stored = localStorage.getItem(KEYS.name) || "";

        els.saveName.disabled = val === stored;
        els.clearName.disabled = stored === "";
      }

      function updateAgeState() {
        const val = els.age.value.trim();
        const stored = localStorage.getItem(KEYS.age) || "";

        els.saveAge.disabled = val === stored;
        els.clearAge.disabled = stored === "";
      }

      els.saveName.addEventListener("click", saveName);
      els.clearName.addEventListener("click", clearName);

      els.saveAge.addEventListener("click", saveAge);
      els.clearAge.addEventListener("click", clearAge);

      els.name.addEventListener("input", updateNameState);
      els.age.addEventListener("input", updateAgeState);

      function saveEmergency() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || "";

        if (val === stored) return;

        val
          ? localStorage.setItem(KEYS.emergency, val)
          : localStorage.removeItem(KEYS.emergency);

        showStatus(
          currentLang === "en"
            ? "Emergency contact saved"
            : "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù ◊†◊©◊û◊®",
          2000
        );
        updateEmergencyState();
      }

      function clearEmergency() {
        if (localStorage.getItem(KEYS.emergency) === null) return;

        localStorage.removeItem(KEYS.emergency);
        els.emergency.value = "";

        showStatus(
          currentLang === "en"
            ? "Emergency contact cleared"
            : "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù ◊†◊û◊ó◊ß",
          2000
        );
        updateEmergencyState();
      }

      function updateEmergencyState() {
        const val = els.emergency.value.trim();
        const stored = localStorage.getItem(KEYS.emergency) || "";

        els.saveEmergency.disabled = val === stored;
        els.clearEmergency.disabled = stored === "";
        els.buttons.emergency.disabled = !stored;
      }

      els.saveEmergency.addEventListener("click", saveEmergency);
      els.clearEmergency.addEventListener("click", clearEmergency);
      els.emergency.addEventListener("input", updateEmergencyState);

      /* --- Call buttons --- */
      els.buttons.police.addEventListener(
        "click",
        () => (window.location.href = `tel:${POLICE_NUMBER}`)
      );

      els.buttons.emergency.addEventListener("click", () => {
        const number = localStorage.getItem(KEYS.emergency);
        window.location.href = `tel:${number}`;
      });

      // /* --- Offline Detection --- */
      function updateOnlineStatus() {
        els.offlineBanner.hidden = navigator.onLine;
        els.submitButton.disabled = !navigator.onLine;
      }

      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);

      /* --- Modal --- */

      let lastFocusedElement = null;

      els.openBtn.addEventListener("click", () => {
        lastFocusedElement = document.activeElement;
        els.modal.showModal();
      });

      els.modal.addEventListener("close", () => {
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
        updateButtonText();
      });

      els.modal.addEventListener("click", (e) => {
        if (e.target === els.modal) {
          els.modal.close();
        }
      });

      els.closeBtn.addEventListener("click", () => {
        els.modal.close();
      });

      function updateButtonText() {
        const checked = document.querySelectorAll(
          'input[name="entry.373709611"]:checked'
        );

        if (checked.length === 0) {
          els.openBtn.textContent = translations[currentLang].select;
        } else if (checked.length === 1) {
          els.openBtn.textContent = checked[0].nextElementSibling.textContent;
        } else {
          els.openBtn.textContent =
            translations[currentLang].selected + " " + checked.length;
        }
      }

      /* --- Submit Form --- */

      const getLocation = () =>
        new Promise((resolve) => {
          if (!navigator.geolocation) return resolve("unknown");

          navigator.geolocation.getCurrentPosition(
            (pos) => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`),
            (err) => {
              console.warn("Geolocation error:", err);
              resolve("unknown");
            },
            {
              enableHighAccuracy: true, // try for more precise location
              timeout: 5000, // wait up to 5 seconds
              maximumAge: 0, // don't use cached location
            }
          );
        });

      function resetIncidentTypes() {
        const checkboxes = document.querySelectorAll(
          'input[name="entry.373709611"]'
        );

        checkboxes.forEach((cb) => {
          cb.checked = false;
        });

        updateButtonText();
      }

      function finalizeSubmit() {
        els.form.submit();
        els.form.style.display = "none";
        els.successMessage.hidden = false;
        els.anotherReport.hidden = false;
        resetIncidentTypes();
        loadIncidents();
      }

      els.form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const now = new Date();

        // Fill date and time if empty
        els.formDate.value ||= now.toISOString().split("T")[0];
        els.formTime.value ||= now.toTimeString().slice(0, 5);

        // Fill location or convert text ‚Üí coordinates
        if (!els.location.value) {
          els.location.value = await getLocation();
        } else if (!looksLikeCoordinates(els.location.value)) {
          const coords = await geocodeLocationText(els.location.value);
          if (!coords) {
            alert("Could not resolve location. Please be more specific.");
            return;
          }
          els.location.value = coords;
        }

        // add incidents to form
        const checked = document.querySelectorAll(
          'input[name="entry.373709611"]:checked'
        );

        // todo: fill in input
        els.hiddenInputs.value = Array.from(checked)
          .map((option) => option.value)
          .join(", ");
        finalizeSubmit();
      });

      els.anotherReport.addEventListener("click", () => {
        els.form.style.display = "block";
        els.successMessage.hidden = true;
        els.anotherReport.hidden = true;
        els.location.value = "";
        els.formDate.value = "";
        els.formDate.type = "text";
        els.formTime.value = "";
        els.formTime.type = "text";
        els.formDesc.value = "";

        resumed = false;
      });

      /* --- Init --- */
      loadUser();
      updateNameState();
      updateAgeState();
      updateEmergencyState();
      updateOnlineStatus();
      applyLang(currentLang);

      /* --- Service Worker --- */
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/jwatch/sw.js", { scope: "/jwatch/" })
            .then((reg) => console.log("SW registered:", reg.scope))
            .catch((err) => console.warn("SW register failed:", err));
        });
      }
    </script>
  </body>
</html>
