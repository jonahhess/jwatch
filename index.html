<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="South Jerusalem Watch" />
    <meta name="theme-color" content="#0f172a" />

    <!-- iOS PWA -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SJ Watch" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png" />

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" href="/favicon-16x16.png" type="image/png" />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Manifest -->
    <link rel="canonical" href="https://jonahhess.github.io/jwatch/" />
    <link
      rel="manifest"
      href="https://jonahhess.github.io/jwatch/manifest.json"
    />

    <title>South Jerusalem Watch</title>

    <style>
      :root {
        /* Spacing scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 1rem;
        --space-4: 1.5rem;
        --space-5: 2rem;

        /* Typography */
        --font-base: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;

        --text-base: 1rem;
        --text-small: 0.875rem;
        --text-large: 1.25rem;

        /* Colors (neutral on purpose) */
        --color-bg: #f7f7f7;
        --color-surface: #ffffff;
        --color-text: #1a1a1a;
        --color-muted: #666;
        --color-border: #ddd;
        --color-accent: #0a66c2;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        font-family: var(--font-base);
        font-size: 100%;
        line-height: 1.5;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
        max-width: 900px;
        margin: auto;
        -webkit-text-size-adjust: 100%;
      }

      .title-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
        column-gap: 0.75rem;
        align-items: center;
      }

      /* Logo: align with title row only */
      #logo-container {
        grid-column: 1;
        grid-row: 1;
        margin-top: 0.75rem;
      }

      #logo-container img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        display: block;
      }

      /* Title */
      .title-meta h1 {
        grid-column: 2;
        grid-row: 1;

        margin: 0;
        font-size: 1.25rem;
        line-height: 1.2;
      }

      /* Meta text below title */
      .title-meta .meta {
        grid-column: 2;
        grid-row: 2;

        font-size: 0.875rem;
        color: #666;
      }

      section {
        margin: var(--space-2);
      }

      .container {
        padding-left: var(--space-3);
        padding-right: var(--space-3);
      }

      .offline-banner {
        background-color: #fffbcc; /* light yellow */
        color: #333;
        padding: var(--space-2) var(--space-3);
        text-align: center;
        font-size: var(--text-small);
        border-bottom: 1px solid #f0e68c;
        position: sticky;
        top: 0;
        z-index: 1001;
      }

      .offline iframe {
        opacity: 0.5;
        pointer-events: none; /* prevents confusing clicks */
      }

      header {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .meta {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      header {
        position: relative; /* keep for layout */
        z-index: 0; /* ensure popover is above */
        overflow: visible; /* most common culprit */
      }

      .quick-report-group {
        margin-bottom: var(--space-1);
      }

      button {
        font: inherit;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      button:hover {
        background: #f0f0f0;
      }

      .button-group {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
        margin-top: var(--space-2);
      }

      .popover {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--space-2);
        padding: calc(var(--space-3) * 1.5);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        max-width: min(28rem, 90vw);
        position: relative;
      }

      /* Close button */
      .popover-close {
        position: absolute;
        inset-block-start: 0; /* top */
        inset-inline-end: 0; /* right in LTR, left in RTL */

        width: 1.75rem;
        height: 1.75rem;

        display: flex;
        align-items: center;
        justify-content: center;

        background: #eee;
        color: #555;

        border: none;
        border-radius: 0.375rem;

        font-size: var(--text-large);
        line-height: 1;
        cursor: pointer;
      }

      /* Hover / active polish */
      .popover-close:hover {
        background: #ddd;
      }

      .popover-close:active {
        background: #ccc;
      }

      /* Wider variant for forms */
      .popover--wide {
        max-width: min(32rem, 95vw);
      }

      /* Optional: animation */
      .popover:popover-open {
        animation: fade-in 120ms ease-out;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #status {
        min-height: var(--space-4); /* matches typical toast height */
        margin-top: var(--space-2);
      }

      .card {
        background: var(--color-surface);
        border-radius: 0.75rem;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
      }

      .muted {
        color: var(--color-muted);
      }

      .hint {
        font-size: var(--text-small);
        color: var(--color-muted);
      }

      label {
        font-size: var(--text-small);
      }

      input {
        font: inherit;
        padding: var(--space-2);
        border-radius: var(--space-2);
        border: 1px solid var(--color-border);
      }

      .iframe-wrap {
        width: 100%;
        overflow: hidden;
        border-radius: var(--space-2);
      }

      iframe {
        width: 100%;
        min-height: 20rem;
        border: 0;
      }

      html[dir="rtl"] {
        direction: rtl;
      }
    </style>
  </head>

  <body>
    <main class="container" id="main">
      <div
        id="offline-banner"
        class="offline-banner muted"
        hidden
        data-i18n="offline"
      >
        ‚ö†Ô∏è Offline mode: Reporting and map viewing require an internet
        connection.
      </div>

      <header>
        <div class="title-meta">
          <div id="logo-container">
            <img src="favicon.ico" alt="South Jerusalem Watch Logo" />
          </div>
          <h1 data-i18n="title">South JLM Watch</h1>
          <div class="meta" data-i18n="meta">
            A simple community safety reporting demo (south Jerusalem)
          </div>
        </div>

        <div class="header-controls">
          <div class="quick-report-group">
            <button
              id="quick-report"
              aria-describedby="quick-help"
              title="Quick report from your current location"
              data-i18n="quickReport"
            >
              Quick report
            </button>
            <button
              popovertarget="quick-help"
              popovertargetaction="toggle"
              class="icon-button"
              aria-label="Help"
            >
              ?
            </button>

            <div id="quick-help" popover class="popover">
              <button
                type="button"
                class="popover-close"
                popovertarget="quick-help"
                popovertargetaction="hide"
                aria-label="Close"
              >
                ‚úï
              </button>
              <strong data-i18n="qrTitle">Quick report</strong>
              <p data-i18n="qrText">
                Use your phone to quickly send a short report with your
                location.
              </p>
            </div>

            <button
              type="button"
              popovertarget="user-info"
              popovertargetaction="toggle"
              class="user-toggle"
              title="Edit your personal info"
            >
              üë§
            </button>

            <div id="user-info" popover class="popover popover--wide">
              <button
                type="button"
                class="popover-close"
                popovertarget="user-info"
                popovertargetaction="hide"
                aria-label="Close"
              >
                ‚úï
              </button>
              <h2 data-i18n="userHeading">Your info</h2>
              <small class="hint" data-i18n="hint">
                Saved locally on this device
              </small>

              <div class="inline-inputs">
                <label>
                  <div class="label-bold" data-i18n="name">Name</div>
                  <input id="user-name" type="text" autocomplete="name" />
                </label>

                <label>
                  <div class="label-bold" data-i18n="age">Age</div>
                  <input
                    id="user-age"
                    type="number"
                    min="0"
                    max="120"
                    inputmode="numeric"
                  />
                </label>

                <label>
                  <div class="label-bold" data-i18n="emergencyContact">
                    Emergency Contact
                  </div>
                  <input
                    id="user-emergency-contact"
                    type="phone"
                    inputmode="numeric"
                  />
                </label>

                <div class="button-group">
                  <button id="save-user" class="btn-light" data-i18n="save">
                    Save
                  </button>
                  <button id="clear-user" class="btn-light" data-i18n="clear">
                    Clear
                  </button>
                </div>
              </div>
              <div id="status" role="status" aria-live="polite"></div>
            </div>
          </div>

          <!-- Calls + Language Toggle -->
          <div class="button-group">
            <button
              id="call-police"
              class="call-button"
              aria-pressed="false"
              title="Call Police"
              data-i18n="callPolice"
            >
              Police üìû
            </button>
            <button
              id="call-emergency-contact"
              class="call-button"
              aria-pressed="false"
              title="Call Emergency Contact"
              data-i18n="callEmergencyContact"
            >
              Emergency Contact üìû
            </button>
            <button
              id="lang-toggle"
              aria-pressed="false"
              title="Toggle language"
              data-i18n="toggle"
            >
              ◊¢◊ë◊®◊ô◊™ üáÆüá±
            </button>
          </div>
        </div>
      </header>

      <!-- Main form section -->
      <section class="card" aria-labelledby="form-heading">
        <div class="iframe-wrap" title="Incident report form">
          <iframe
            id="form-frame"
            loading="lazy"
            src="https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true"
            title="Report an incident (Google Form)"
            aria-label="Report an incident form"
          ></iframe>
        </div>

        <p class="muted" data-i18n="prefillHint">
          The form will be prefilled with your location, cached name & age, and
          the current date/time.
        </p>
      </section>

      <!-- Map section -->
      <section class="card" aria-labelledby="map-heading">
        <div class="iframe-wrap">
          <iframe
            id="map-frame"
            loading="lazy"
            src="https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=en&noprof=1"
            title="Incident map"
            aria-label="Incident map"
          ></iframe>
        </div>

        <p class="muted" data-i18n="mapHint">
          Tip: tap the map title to open My Maps in a new tab for full
          interaction.
        </p>
      </section>

      <section id="about-section" class="card">
        <h2 data-i18n="about">About</h2>
        <p data-i18n="desc">
          This is a website dedicated to keeping kids safe on the streets
        </p>
      </section>

      <noscript class="card">
        <strong
          >JavaScript required for quick reporting and language toggle.</strong
        >
        <div>
          If JavaScript is disabled you can still use the embedded Google Form
          and map, but quick location-based reporting won't work.
        </div>
      </noscript>
    </main>

    <script>
      /* --- DOM helpers --- */
      const $ = (id) => document.getElementById(id);

      const els = {
        html: document.documentElement,
        main: $("main"),
        offlineBanner: $("offline-banner"),
        quickReportButton: $("quick-report"),
        status: $("status"),
        toggle: $("quick-help-toggle"),
        content: $("quick-help-content"),
        userToggle: $("user-info-toggle"),
        userContent: $("user-info-content"),
        langToggle: $("lang-toggle"),
        form: $("form-frame"),
        map: $("map-frame"),
        buttons: {
          quick: $("quick-report"),
          police: $("call-police"),
          emergency: $("call-emergency-contact"),
        },
        user: {
          name: $("user-name"),
          age: $("user-age"),
          emergency: $("user-emergency-contact"),
          save: $("save-user"),
          clear: $("clear-user"),
        },
      };

      /* --- Constants --- */
      const GOOGLE_FORM_BASE =
        "https://docs.google.com/forms/d/e/1FAIpQLSdXEYB3aVM8UUtkrnIdSF6xs2jmmYz9v2zqvz366n5f9U8nqQ/viewform?embedded=true";
      const GOOGLE_MAP_BASE =
        "https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=en&noprof=1";
      const POLICE_NUMBER = "100";

      const KEYS = {
        name: "sjw-user-name",
        age: "sjw-user-age",
        emergency: "sjw-user-emergency-contact",
      };

      /* --- URLs --- */
      const formUrls = {
        en: GOOGLE_FORM_BASE,
        he: "https://docs.google.com/forms/d/e/1FAIpQLSe5tQtDXNzq-4zxHuJaeFwXiPQx4y3krkY90cXyXVDLACMryA/viewform?embedded=true",
      };

      const mapUrls = {
        en: GOOGLE_MAP_BASE,
        he: "https://www.google.com/maps/d/u/0/embed?mid=1lU5wC1eUf-2G_CqscFUypTQIDBxRxr0&ehbc=2E312F&hl=he&noprof=1",
      };

      /* --- Google Form entries mapping --- */
      const entries = {
        en: {
          name: "entry.1563137864",
          age: "entry.552093736",
          location: "entry.1771840150",
          date: "entry.123356142",
          time: "entry.407216857",
        },
        he: {
          name: "entry.1351340282",
          age: "entry.1932330829",
          location: "entry.477369262",
          date: "entry.411715491",
          time: "entry.462606047",
        },
      };

      /* --- Translations --- */
      const translations = {
        en: {
          title: "South JLM Watch",
          meta: "A simple community safety reporting demo (south Jerusalem)",
          offline:
            "‚ö†Ô∏è Offline mode: Reporting and map viewing require an internet connection.",
          quickReport: "Quick report",
          callPolice: "Police üìû",
          callEmergencyContact: "Emergency Contact üìû",
          toggle: "◊¢◊ë◊®◊ô◊™ üáÆüá±",
          userHeading: "Your info",
          hint: "Saved locally on this device",
          name: "Name",
          age: "Age",
          emergencyContact: "Emergency Contact",
          save: "Save",
          clear: "Clear",
          prefillHint:
            "The form will be prefilled with your location, cached name & age, and the current date/time.",
          about: "About",
          desc: "This is a website dedicated to keeping kids safe on the streets.",
          privacy:
            "No authentication. Public data only. Do not include personal or sensitive information.",
          qrTitle: "Quick report",
          qrText:
            "Use your phone to quickly send a short report with your location. The form will be prefilled inside the app.",
          mapHint:
            "Tip: tap the map title to open My Maps in a new tab for full interaction.",
          quickBtn: "Quick report",
        },
        he: {
          title: "◊û◊©◊û◊® ◊ì◊®◊ï◊ù ◊ô◊®◊ï◊©◊ú◊ô◊ù",
          meta: "◊í◊®◊°◊™ ◊î◊ì◊í◊û◊î ◊ú◊ì◊ô◊ï◊ï◊ó ◊ß◊î◊ô◊ú◊™◊ô (◊ì◊®◊ï◊ù ◊ô◊®◊ï◊©◊ú◊ô◊ù)",
          offline: "‚ö†Ô∏è ◊ú◊ê ◊û◊ó◊ï◊ë◊® ◊ú◊ê◊ô◊†◊ò◊®◊†◊ò. ◊î◊ò◊ï◊§◊° ◊ï◊î◊û◊§◊î ◊ú◊ê ◊ô◊¢◊ë◊ì◊ï.",
          quickReport: "◊ì◊ô◊ï◊ï◊ó ◊û◊î◊ô◊®",
          callPolice: " ◊ú◊û◊©◊ò◊®◊î üìû",
          callEmergencyContact: " ◊ú◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù üìû",
          toggle: "English üá∫üá∏",
          userHeading: "◊î◊û◊ô◊ì◊¢ ◊©◊ú◊ö",
          hint: "◊†◊©◊û◊® ◊û◊ß◊ï◊û◊ô◊™ ◊ë◊û◊õ◊©◊ô◊® ◊ñ◊î",
          name: "◊©◊ù",
          age: "◊í◊ô◊ú",
          emergencyContact: "◊ê◊ô◊© ◊ß◊©◊® ◊ó◊ô◊®◊ï◊ù",
          save: "◊©◊û◊ï◊®",
          clear: "◊û◊ó◊ß",
          prefillHint: "◊î◊ò◊ï◊§◊° ◊ô◊û◊ï◊ú◊ê ◊ë◊û◊ô◊ß◊ï◊ù, ◊©◊ù ◊ï◊í◊ô◊ú ◊ï◊©◊¢◊™/◊™◊ê◊®◊ô◊ö ◊î◊ì◊ô◊ï◊ï◊ó.",
          about: "◊ê◊ï◊ì◊ï◊™",
          desc: "◊ñ◊î ◊ê◊™◊® ◊©◊û◊ï◊ß◊ì◊© ◊ú◊©◊û◊ô◊®◊î ◊¢◊ú ◊ô◊ú◊ì◊ô◊†◊ï ◊ë◊®◊ó◊ï◊ë.",
          privacy:
            "◊ú◊ú◊ê ◊ê◊ô◊û◊ï◊™. ◊†◊™◊ï◊†◊ô◊ù ◊í◊ú◊ï◊ô◊ô◊ù ◊ú◊¶◊ô◊ë◊ï◊® ◊ë◊ú◊ë◊ì. ◊ê◊ú ◊™◊õ◊ú◊ú◊ï ◊û◊ô◊ì◊¢ ◊ê◊ô◊©◊ô ◊ê◊ï ◊®◊í◊ô◊©.",
          qrTitle: "◊ì◊ô◊ï◊ï◊ó ◊û◊î◊ô◊®",
          qrText:
            "◊î◊©◊™◊û◊©◊ï ◊ë◊ò◊ú◊§◊ï◊ü ◊õ◊ì◊ô ◊ú◊©◊ú◊ï◊ó ◊ì◊ô◊ï◊ï◊ó ◊ß◊¶◊® ◊¢◊ù ◊î◊û◊ô◊ß◊ï◊ù ◊©◊ú◊õ◊ù. ◊î◊ò◊ï◊§◊° ◊ô◊û◊ï◊ú◊ê ◊û◊®◊ê◊© ◊ë◊™◊ï◊ö ◊î◊ê◊§◊ú◊ô◊ß◊¶◊ô◊î.",
          mapHint:
            "◊ò◊ô◊§: ◊î◊ß◊ô◊©◊ï ◊¢◊ú ◊õ◊ï◊™◊®◊™ ◊î◊û◊§◊î ◊õ◊ì◊ô ◊ú◊§◊™◊ï◊ó ◊ê◊™ My Maps ◊ë◊õ◊®◊ò◊ô◊°◊ô◊ô◊î ◊ó◊ì◊©◊î.",
          quickBtn: "◊ì◊ï◊ï◊ó ◊û◊î◊†◊ô◊ô◊ì",
        },
      };

      /* --- Helpers --- */
      let currentLang = localStorage.getItem("sjw-lang") || "en";

      function showStatus(text, ms = 3000) {
        if (!els.status) return;
        els.status.textContent = text;
        clearTimeout(showStatus._t);
        if (ms > 0)
          showStatus._t = setTimeout(() => (els.status.textContent = ""), ms);
      }

      function formatDateISO(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function formatTimeHHMM(d) {
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function buildPrefillUrl(prefill) {
        const usp = "usp=pp_url";
        const params = new URLSearchParams(prefill);
        return `${
          formUrls[currentLang] || GOOGLE_FORM_BASE
        }?${usp}&${params.toString()}`;
      }

      async function getLocation() {
        if (!navigator.geolocation) return "";
        try {
          const pos = await new Promise((res, rej) =>
            navigator.geolocation.getCurrentPosition(res, rej, {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 8000,
            })
          );
          return `${pos.coords.latitude.toFixed(
            6
          )},${pos.coords.longitude.toFixed(6)}`;
        } catch {
          return "";
        }
      }

      /* --- Language --- */
      function updateText(lang) {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.dataset.i18n;
          if (translations[lang] && translations[lang][key])
            el.textContent = translations[lang][key];
        });
        if (els.form) els.form.src = formUrls[lang] || formUrls.en;
        if (els.map) els.map.src = mapUrls[lang] || mapUrls.en;
      }

      function applyLang(lang) {
        currentLang = lang;
        els.html.lang = lang;
        els.html.dir = lang === "he" ? "rtl" : "ltr";
        localStorage.setItem("sjw-lang", lang);
        updateText(lang);
        els.langToggle.setAttribute("aria-pressed", lang === "he");
      }

      els.langToggle.addEventListener("click", () =>
        applyLang(currentLang === "en" ? "he" : "en")
      );
      els.langToggle.addEventListener("keydown", (e) => {
        if (["Enter", " "].includes(e.key)) {
          e.preventDefault();
          e.target.click();
        }
      });

      /* --- User cache --- */
      function loadUser() {
        els.user.name.value = localStorage.getItem(KEYS.name) || "";
        els.user.age.value = localStorage.getItem(KEYS.age) || "";
        els.user.emergency.value = localStorage.getItem(KEYS.emergency) || "";
      }

      function updateClearState() {
        const hasCached = Object.values(KEYS).some(
          (k) => localStorage.getItem(k) !== null
        );
        if (els.user && els.user.clear) els.user.clear.disabled = !hasCached;
      }

      function updateEmergencyContactButtonState() {
        const hasNumber = localStorage.getItem(KEYS.emergency);
        if (els.buttons && els.buttons.emergency) {
          els.buttons.emergency.disabled = !hasNumber;
        }
      }

      function saveUser() {
        const isChange = Object.entries(KEYS).some(([k, storageKey]) => {
          const input = els.user[k];
          const val = input && input.value ? input.value.trim() : "";
          const stored = localStorage.getItem(storageKey) || "";
          return val !== stored;
        });
        if (!isChange) return;
        Object.entries(KEYS).forEach(([k, storageKey]) => {
          const el = els.user[k];
          const val = el && el.value ? el.value.trim() : "";
          val
            ? localStorage.setItem(storageKey, val)
            : localStorage.removeItem(storageKey);
        });
        showStatus(currentLang === "he" ? "◊î◊û◊ô◊ì◊¢ ◊†◊©◊û◊®" : "Info saved", 2000);
        updateSaveState();
        updateClearState();
        updateEmergencyContactButtonState();
      }

      function updateSaveState() {
        const hasChange = Object.entries(KEYS).some(([k, storageKey]) => {
          const input = els.user[k];
          const val = input && input.value ? input.value.trim() : "";
          const stored = localStorage.getItem(storageKey) || "";
          return val !== stored;
        });
        if (els.user && els.user.save) els.user.save.disabled = !hasChange;
      }

      function clearUser() {
        const isCached = Object.values(KEYS).some(
          (k) => localStorage.getItem(k) !== null
        );
        if (!isCached) return;
        Object.values(KEYS).forEach((k) => localStorage.removeItem(k));
        Object.values(els.user).forEach((el) => {
          if (el.tagName === "INPUT") el.value = "";
        });
        showStatus(currentLang === "he" ? "◊î◊û◊ô◊ì◊¢ ◊†◊û◊ó◊ß" : "Info cleared", 2000);
        updateSaveState();
        updateClearState();
        updateEmergencyContactButtonState();
      }

      els.user.save.addEventListener("click", saveUser);
      els.user.clear.addEventListener("click", clearUser);

      els.user.name.addEventListener("input", updateSaveState);
      els.user.age.addEventListener("input", updateSaveState);
      els.user.emergency.addEventListener("input", updateSaveState);

      /* --- Call buttons --- */
      els.buttons.police.addEventListener(
        "click",
        () => (window.location.href = `tel:${POLICE_NUMBER}`)
      );
      els.buttons.emergency.addEventListener("click", () => {
        const number = localStorage.getItem(KEYS.emergency);
        window.location.href = `tel:${number}`;
      });

      /* --- Quick report --- */
      els.buttons.quick.addEventListener("click", async () => {
        const now = new Date();
        const cachedName = localStorage.getItem(KEYS.name) || "";
        const cachedAge = localStorage.getItem(KEYS.age) || "";
        const e = entries[currentLang];
        const prefill = {};

        if (cachedName) prefill[e.name] = cachedName;
        if (cachedAge) prefill[e.age] = cachedAge;

        prefill[e.date] = formatDateISO(now);
        prefill[e.time] = formatTimeHHMM(now);

        const loc = await getLocation();
        if (loc) prefill[e.location] = loc;

        els.form.src = buildPrefillUrl(prefill);
      });

      // /* --- Offline Detection --- */
      function updateOnlineStatus() {
        els.main.classList.toggle("offline", !navigator.onLine);
        els.offlineBanner.hidden = navigator.onLine;
        els.quickReportButton.disabled = !navigator.onLine;
      }

      // Listen for changes
      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);

      /* --- Popover focus helper --- */
      const popovers = document.querySelectorAll(".popover");

      popovers.forEach((popover) => {
        popover.addEventListener("click", (e) => {
          const isInput =
            e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA";
          if (!isInput) {
            // Remove focus from any input inside this popover
            popover
              .querySelectorAll("input, textarea")
              .forEach((input) => input.blur());
          }
        });
      });

      /* --- Init --- */
      loadUser();
      updateSaveState();
      updateClearState();
      updateEmergencyContactButtonState();
      updateOnlineStatus();
      applyLang(currentLang);

      /* --- Service Worker --- */
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/jwatch/sw.js", { scope: "/jwatch/" })
            .then((reg) => console.log("SW registered:", reg.scope))
            .catch((err) => console.warn("SW register failed:", err));
        });
      }
    </script>
  </body>
</html>
